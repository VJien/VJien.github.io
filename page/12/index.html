<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="https://img.supervj.top/imgHEAD_Icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://img.supervj.top/imgHEAD_Icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="https://img.supervj.top/imgHEAD_Icon.png">
  <link rel="mask-icon" href="https://img.supervj.top/imgHEAD_Icon.png" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ma+Shan+Zheng:300,300italic,400,400italic,700,700italic|Noto+Sans+Simplified+Chinese:300,300italic,400,400italic,700,700italic|Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.css">
  <script src="//cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.js"></script>

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"supervj.top","root":"/","images":"/images","scheme":"Pisces","version":"8.1.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="如果我们不曾相遇">
<meta property="og:type" content="website">
<meta property="og:title" content="月光林地">
<meta property="og:url" content="http://supervj.top/page/12/index.html">
<meta property="og:site_name" content="月光林地">
<meta property="og:description" content="如果我们不曾相遇">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="VJ东">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://supervj.top/page/12/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>
<title>月光林地</title>
  



  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">月光林地</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <section class="post-toc-wrap sidebar-panel">
        </section>
        <!--/noindex-->

        <section class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="VJ东"
      src="https://img.supervj.top/imgHEAD_Icon.png">
  <p class="site-author-name" itemprop="name">VJ东</p>
  <div class="site-description" itemprop="description"> 如果我们不曾相遇 </div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">128</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">109</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="/389278697@qq.com" title="E-Mail → 389278697@qq.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license site-overview-item animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



        </section>
      </div>
        <div class="back-to-top animated">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/VJien" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/22/LearnDX12_Init/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/22/LearnDX12_Init/" class="post-title-link" itemprop="url">DX学习笔记（二）：DX初始化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-22 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-22T00:00:00+08:00">2020-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:40:31" itemprop="dateModified" datetime="2021-08-02T16:40:31+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/22/LearnDX12_Init/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/22/LearnDX12_Init/" class="cy_cmt_count" data-xid="2020/06/22/LearnDX12_Init/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>43k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>39 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Direct3D初始化"><a href="#Direct3D初始化" class="headerlink" title="Direct3D初始化"></a>Direct3D初始化</h2><h3 id="预备知识"><a href="#预备知识" class="headerlink" title="预备知识"></a>预备知识</h3><h5 id="组件对象模型"><a href="#组件对象模型" class="headerlink" title="组件对象模型"></a>组件对象模型</h5><p>组件对象模型<em><strong>（Component Object Model,COM）</strong></em>:不受DirectX语言束缚，并且向后兼容的技术</p>
<ul>
<li>获得COM接口需要借助特定函数，而不是C++的new</li>
<li>删除COM有Release方法，而不是delete</li>
<li><code>Mirrosoft::WRL::ComPtr</code>类是Window是下的<em><strong>COM</strong></em>对象的智能指针</li>
<li>当<em><strong>ComPtr</strong></em>出作用域时，它会自动调用Release方法</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Get: 返回一个指向此底层COM接口的指针，此方法常用于把原始COM接口指针作为参数传给函数</span></span><br><span class="line">ComPtr&lt;ID3D12RootSignature&gt; mRootSignature;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">//SetGraphicsRootSignature需要获取ID3D12RootSignature*类型的参数</span></span><br><span class="line">    mCommandList-&gt;<span class="built_in">SetGraphicsRootSignature</span>(mRootSignature.<span class="built_in">Get</span>());</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//GetAddressOf:返回指向此底层COM接口指针的地址，此函数可以利用函数参数返回COM接口的指针</span></span><br><span class="line">ComPtr&lt;ID3D12CommandAlllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">...</span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(</span><br><span class="line">        D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">    mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>());</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Reset:将此ComPtr实例设置为nullptr释放与之相关的所有引用，同时减少COM接口引用次数，此方法功能与将ComPtr目标实例赋值nullptr效果相同</span></span><br></pre></td></tr></table></figure>

<h5 id="纹理格式"><a href="#纹理格式" class="headerlink" title="纹理格式"></a>纹理格式</h5><p>2D纹理是一种由数据元素构成的矩阵，每个元素存储的都是一个像素的颜色</p>
<ul>
<li><p><strong>DXGI_FORMAT_R32G32B32_FLOAT</strong>:每个元素由2个32位无符号整数分量构成，<strong>存储的不一定是颜色信息</strong></p>
</li>
<li><p><strong>DXGI_FORMAT_R16G16B16A16_UNORM</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[0，1]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R32G32_UINT</strong>:每个元素由2个32位无符号整数分量构成</p>
</li>
<li><p><strong>DXGI_FORMAT_R8G8B8A8_UNORM</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[0，1]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R8G8B8A8_SNORM</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[-1，1]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R9G9B9A9_SINT</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[-128，127]**的区间</p>
</li>
<li><p><strong>DXGI_FORMAT_R8G8B8A8_UINT</strong>:每个元素由4个8位无符号分量构成，每个分量都被映射到**[0，255]**的区间</p>
</li>
</ul>
<p>其他格式</p>
<ul>
<li>DXGI_FORMAT_R16G16B16A16_TYPELESS:每个元素由4个16位无符号分量构成，<strong>但是没有指出数据类型</strong></li>
</ul>
<h5 id="交换链和页面翻转"><a href="#交换链和页面翻转" class="headerlink" title="交换链和页面翻转"></a>交换链和页面翻转</h5><p><img src="https://img.supervj.top/img/PathOptimization/image-20200122072822631.png"></p>
<ul>
<li>前台缓冲区和后台缓冲区在绘制渲染过程中互换，这种操作称为：<strong>呈现（presenting，亦有译作提交、显示）</strong></li>
<li>前后台缓冲区构成了交换链，Direct3D中用==<code>IDXGISwapChain</code>==接口来表示</li>
<li>这个接口不仅储存了前后台缓冲区的纹理，还提供了修改缓冲区大小(<em><strong>IDXGISwapChain::ResiezeBuffers</strong></em>)和呈现缓冲区内容(<em><strong>IDXGISwapChain::Present</strong></em>)的方法</li>
<li>使用2个缓冲区的情况称为<em><strong>双缓冲(double buffering,亦有译作双重缓冲、双倍缓冲等)</strong></em></li>
<li>还可以用更多的缓冲区，使用3个缓冲区就叫作<em><strong>三重缓冲（triple buffering）</strong></em></li>
</ul>
<h5 id="深度缓冲"><a href="#深度缓冲" class="headerlink" title="深度缓冲"></a>深度缓冲</h5><p><strong>深度缓冲区（depth buffer）</strong>：存储的非图像数据，而是特定像素的深度信息</p>
<ul>
<li>深度值范围 <em><strong>0.0-1.0</strong></em></li>
<li><strong>0.0</strong>代表观察者在<em><strong>视锥体</strong></em>（视域体、视景体、视截体、视体），即观察者能看到的空间范围</li>
<li><strong>1.0</strong>代表观察者在视锥体中嫩通过看到的离自己最远的像素</li>
<li>如果后台缓冲区的分辨率位<em>1280x1024</em>,那么深度缓冲去也应当由<em>1280x1024</em></li>
</ul>
<p><strong>深度缓冲区的原理</strong>：计算每个像素的深度值，并执行<em><strong>深度测试（depth test）</strong></em>，具有最小深度值的像素会最终写入后台缓冲</p>
<p>深度缓冲区也是一种纹理，用如下格式来创建</p>
<ol>
<li>DXGI_FORMAT_D32_FLOAT_S8X24_UINT:占用64位，取其中的32位指定一个浮点型深度缓冲区，另有8位无符号整数分配给<em><strong>模板缓冲区(stencil buffer)</strong></em>,并且将该元素映射到[<em><strong>0,255</strong></em>]</li>
<li> DXGI_FORMAT_D32_FLOAT:指定一个32位浮点型深度缓冲区</li>
<li> DXGI_FORMAT_D24_UNORM_指定一个无符号的24位深度缓冲区，并将该元素映射到[<em><strong>0,1</strong></em>]区间；另有8位无符号整数分配给<em><strong>模板缓冲区(stencil buffer)</strong></em>,并且将该元素映射到[<em><strong>0,255</strong></em>]</li>
<li>DXGI_FORMAT_D16_UNORM:指定一个16位浮点型深度缓冲区，并将该元素映射到[<em><strong>0,1</strong></em>]区间</li>
</ol>
<h5 id="资源与描述符"><a href="#资源与描述符" class="headerlink" title="资源与描述符"></a>资源与描述符</h5><blockquote>
<p>资源-&gt;中间层（即描述符）-&gt;GPU</p>
</blockquote>
<p><strong>描述符</strong></p>
<ul>
<li>一种把送往GPU的资源进行描述的轻量级结构；</li>
<li> 绘制所需的资源通过描述符绑定到渲染流水线上；</li>
<li> 为GPU解释资源，如告知Direct3D某个资源如何使用（绑定到流水线的哪个阶段）；</li>
<li> 指定欲绑定资源中的局部数据</li>
</ul>
<h6 id="常见描述符"><a href="#常见描述符" class="headerlink" title="常见描述符"></a>常见描述符</h6><ol>
<li><em><strong>CBV/SRV/UAV</strong></em> ：分表表示常量缓冲区(constant buffer view)、着色器资源视图(shader resource view)和无序访问试图(unordered access view)3种资源；</li>
<li>***采样器(sampler，亦有译作取样器)***：表示采样器资源（用于纹理）</li>
<li><em><strong>RTV</strong></em>:渲染目标视图资源(render target view)</li>
<li><em><strong>DSV</strong></em>：深度/模板视图资源(depth/stencil view)</li>
</ol>
<p><strong>描述符堆</strong>：存放某种特定类描述符的内存，可以看作是描述符数组</p>
<h5 id="多重采样"><a href="#多重采样" class="headerlink" title="多重采样"></a>多重采样</h5><h6 id="超级采样（SSAA）"><a href="#超级采样（SSAA）" class="headerlink" title="超级采样（SSAA）"></a>超级采样（SSAA）</h6><p>超级采样：反走样技术</p>
<ul>
<li>使用4倍于屏幕分辨率大小的后台缓冲区和深度缓冲去；</li>
<li>3D场景以这种更大的分辨率渲染到后台缓冲区中；</li>
<li>当数据要从后台缓冲区调往屏幕显示的时候，会将后台缓冲区按4个像素一组进行解析（降采样,downsample），把放大的采样点数降低回原来采样点数每组用求平均值的方法得到相对平滑的像素颜色</li>
<li>实际上是通过软件的方式提升了画面分辨率</li>
<li>超级采样是高开销的操作，因为限速处理数量和占用内存大小都增加到了4倍，因此Direct3D支持一种<strong>性能和效果</strong>折中的反走样技术：<em><strong>多重采样(multisampling)</strong></em>,记作<em><strong>MSAA</strong></em></li>
</ul>
<h6 id="多重采样（MSAA）"><a href="#多重采样（MSAA）" class="headerlink" title="多重采样（MSAA）"></a>多重采样（MSAA）</h6><ul>
<li>多重采样不需要对每个子像素都进行计算</li>
<li>而是仅计算一次像素中心的颜色，在基于可视性和覆盖性将得到的颜色信息分享给其子像素</li>
</ul>
<h6 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h6><ul>
<li><p>超级采样：图像颜色要根据每一个像素来计算，因此每个子像素都可以各具不的颜色；开销更大但是更精确</p>
</li>
<li><p>多重采样：每个像素只需要计算一次，最后假尼姑得到的颜色数据复制到多边形覆盖的所有可见子像素中</p>
</li>
</ul>
<h5 id="用Direct3D进行多重采样"><a href="#用Direct3D进行多重采样" class="headerlink" title="用Direct3D进行多重采样"></a>用Direct3D进行多重采样</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_SAMPLE_DESC</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UINT count;<span class="comment">//指定了每个像素的采样次数，采样次数越多，代价越高</span></span><br><span class="line">    UINT Quality;;<span class="comment">//指示用户期望的图像质量级别，不同厂家而言，这个参数相差很多</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据给定的纹理格式和采样数量，用<code>ID3D12Device::CheckFeatureSupport</code>方法查询对应的质量级别</p>
<ul>
<li>考虑到多重采样会占用内存资源，又为了保证程序性能等原因，通常会把采样数量设定位 <em><strong>4 或 8</strong></em></li>
<li>如果不希望使用多重采样，可以设置采样数量位1，质量设置为0</li>
</ul>
<h5 id="功能级别"><a href="#功能级别" class="headerlink" title="功能级别"></a>功能级别</h5><p>Direct3D 11开始引用了<em><strong>功能级别(feature level)</strong></em>,代码里用 <code>D3D_FEATURE_LEVEL</code>表示</p>
 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">D3D_FEATURE_LEVEL</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    D3D_FEATURE_LEVEL_9_1 = <span class="number">0x9100</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_9_2 = <span class="number">0x9200</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_9_3 = <span class="number">0x9300</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_10_0 = <span class="number">0xa000</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_10_1 = <span class="number">0xa100</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_11_0 = <span class="number">0xb000</span>,</span><br><span class="line">    D3D_FEATURE_LEVEL_11_1 = <span class="number">0xb100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>功能级别为不同级别所支持的功能进行严格界定</li>
</ul>
<h5 id="DirectX图形学基础结构"><a href="#DirectX图形学基础结构" class="headerlink" title="DirectX图形学基础结构"></a>DirectX图形学基础结构</h5><p>DirectX图形学基础结构(DXGI)是一种与<em><strong>Direct3D配合使用的API</strong></em></p>
<p>如，<code>IDXGIFactory</code>是DXGI中的关键接口之一，用于创建<code>IDXGISwapChain</code>接口以及枚举<strong>显示适配器</strong></p>
<p>一个系统可能由数个显示设备，我们称每一台显示设备都是一个<strong>显示输出</strong>，用<code>IDXGIOutput</code>接口来表示</p>
<h5 id="功能支持的检测"><a href="#功能支持的检测" class="headerlink" title="功能支持的检测"></a>功能支持的检测</h5><p><code>ID3D12Device::CheckFeatureSupport</code>方法是检测当前图形驱动对多重过采样的支持，圆形如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::CheckFeatureSupport</span><span class="params">(D3D12_FEATURE Feature,<span class="keyword">void</span>* pFeatureSuportData,UINT FeatureSupportDataSize)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>***Feature:***枚举类型<code>D3D12_FEATURE</code>中的成员之一，用于指定我们希望检测的功能支持类型，具体如下</p>
<ul>
<li>D2D12_FEATURE_D3D12_OPTIONS:检测当前图形驱动对Direct3D 12各种功能的支持情况</li>
<li>D3D12_FEATURE_ARCHITECTURE:检测图形适配器中GPU的硬件体系架构特性</li>
<li>D3D12_FEATURE_FEATURE_LEVELS:检测对功能级别的支持情况</li>
<li>D3D12_FEATURE_FORMAT_SUPPORT:检测对给定纹理格式的支持情况</li>
<li>D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS:检测对多重采样功能的支持情况</li>
</ul>
</li>
<li><p><em><strong>pFeatureSuportData</strong></em>：指向某种数据结构的指针，该结构中存有检索到的特定功能支持的信息，<strong>此结构体的具体类型取决于Feature参数</strong></p>
<ul>
<li>D3D12_FEATURE_D3D12_OPTIONS:返回一个D3D12_FEATURE_DATA_D3D12_OPTIONS实例</li>
<li>D3D12_FEATURE_ARCHITECTURE:返回D3D12_FEATURE_ARCHITECTURE实例</li>
<li>D3D12_FEATURE_FEATURE_LEVELS:同上类推</li>
<li>D3D12_FEATURE_FORMAT_SUPPORT：同上类推</li>
<li>D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS：同上类推</li>
</ul>
</li>
<li><p>FeatureSupportDataSize：传回<em><strong>pFeatureSuportData</strong></em>参数中的数据结构大小</p>
</li>
</ul>
<h5 id="资源驻留"><a href="#资源驻留" class="headerlink" title="资源驻留"></a>资源驻留</h5><p>Direct3D12中，应用程序通过控制资源在显存中的去留，主动管理资源的驻留情况（<code>Direct3D11中则有系统自动管理</code>）</p>
<p>一般情况，资源创建时就会驻留在显存中，被销毁时则清出。但是通过下面方法我们可以自己管理资源的驻留</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::MakeResident</span><span class="params">(UINT NumObjects,ID3D12Pageable* <span class="keyword">const</span> *ppObjects)</span></span>;</span><br><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::Evict</span><span class="params">(UINT NumObjects,ID3D12Pageable* <span class="keyword">const</span> *ppObjects)</span></span>;</span><br></pre></td></tr></table></figure>

<p>这两个方法的第二个参数都是<code>ID3D12Pageable</code>资源数组，第一个参数表示该数组资源的数量</p>
<h3 id="CPU和GPU的交互"><a href="#CPU和GPU的交互" class="headerlink" title="CPU和GPU的交互"></a>CPU和GPU的交互</h3><ul>
<li>每个GPU都至少维护这一个命令队列(command queue，本质上是环形缓冲区，即ring buffer)。</li>
<li>借助Direct3D API，CPU可以用命令列表(command list)将命令提交到这个队列中去</li>
<li>新加入的命令不会立即执行</li>
<li>假如命令列表空空如也，那么GPU会闲置</li>
<li>假如命令列表填满，那么CPU会在某个时刻保持空闲</li>
</ul>
<p>在Direct3D 12中，命令队列被抽象为==<code>ID3D12CommandQueue</code>==接口来表示，通过填写<code>D3D12_COMMAND_QUEUE_DESC</code>结构体来表示队列，在通过调用<code>ID3D12Device::CreateCommandQueue</code>方法来创建。</p>
<h5 id="命令队列"><a href="#命令队列" class="headerlink" title="命令队列"></a>命令队列</h5><h6 id="创建命令队列"><a href="#创建命令队列" class="headerlink" title="创建命令队列"></a>创建命令队列</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建队列智能指针</span></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;</span><br><span class="line">...;</span><br><span class="line"></span><br><span class="line">D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line">queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line"><span class="comment">//创建队列方法</span></span><br><span class="line"> <span class="comment">//IID_PPV_ARGS辅助宏本质是将ppType强制转换为void**类型</span></span><br><span class="line"><span class="comment">//Direct3D 12中创建接口实例的API时，大多数都有一个参数是类型void**的待创接口COM ID</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc,<span class="built_in">IID_PPV_ARGS</span>(&amp;mCommandQueue))); </span><br><span class="line"></span><br><span class="line">...;</span><br><span class="line"><span class="comment">//添加命令到命令列表里</span></span><br><span class="line"><span class="comment">//第一个参数是待执行的命令列表数组的数量</span></span><br><span class="line"><span class="comment">//第二个参数是待执行的命令列表数组</span></span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(cmdsLists), cmdsLists);</span><br><span class="line"><span class="comment">//下列两个方法不是执行命令，而是将命令添加到命令列表里，还是需要通过ExecuteCommandLists方法才将命令真正加入到命令列表</span></span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">DrawIndexedInstanced</span>(<span class="number">36</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">RSSetViewports</span>(<span class="number">1</span>,&amp;mScreenViewport);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//结束记录命令</span></span><br><span class="line"><span class="comment">//必须在调用ExecuteCommandLists方法之前先关闭</span></span><br><span class="line"> mCommandQueue-&gt;<span class="built_in">Close</span>();</span><br></pre></td></tr></table></figure>

<h6 id="内存分配器"><a href="#内存分配器" class="headerlink" title="内存分配器"></a>内存分配器</h6><p>内存分配器：存储命令列表里的命令，执行<code>ID3D12CommandQueue::ExecuteCommandLists</code>方法时，<strong>命令队列</strong>就会引用<strong>分配器里的命令</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="title">CreateCommandAllocator</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  D3D12_COMMAND_LIST_TYPE type,</span></span></span><br><span class="line"><span class="params"><span class="function">            REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">            _COM_Outptr_  <span class="keyword">void</span> **ppCommandAllocator)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>type</code>:命令列表类型<ul>
<li><code>D3D12_COMMAND_LIST_TYPE_DIRECT</code>:GPU可直接执行的命令</li>
<li><code>D3D12_COMMAND_LIST_TYPE_BUNDLE</code>:打包的命令列表，一般不用</li>
</ul>
</li>
<li><code>riid</code>：适配接口的COM ID</li>
<li><code>ppCommandAllocator</code>:输出指向所建命令分配器的指针</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//内存管理指针</span></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">...;</span><br><span class="line"></span><br><span class="line"><span class="comment">//第一个参数：此命令分配器相关联的命令列表类型，具体见下图</span></span><br><span class="line"><span class="comment">//第二个参数：内存分配器地址</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>





<h6 id="创建命令列表"><a href="#创建命令列表" class="headerlink" title="创建命令列表"></a>创建命令列表</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//原型</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="title">CreateCommandList</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  UINT nodeMask,</span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  D3D12_COMMAND_LIST_TYPE type,</span></span></span><br><span class="line"><span class="params"><span class="function">            _In_  ID3D12CommandAllocator *pCommandAllocator,</span></span></span><br><span class="line"><span class="params"><span class="function">            _In_opt_  ID3D12PipelineState *pInitialState,</span></span></span><br><span class="line"><span class="params"><span class="function">            REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">            _COM_Outptr_  <span class="keyword">void</span> **ppCommandList)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//实例</span></span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandList</span>(</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		mDirectCmdListAlloc.<span class="built_in">Get</span>(), <span class="comment">// Associated command allocator</span></span><br><span class="line">		<span class="literal">nullptr</span>,                   <span class="comment">// Initial PipelineStateObject</span></span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mCommandList.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>

<ol>
<li>nodeMask:如果只有1个GPU，设置成0；多个GPU用于关联的物理GPU</li>
<li>type:命令列表类型</li>
<li>pCommandAllocator:所建命令列表关联的命令分配器，类型必须匹配</li>
<li>pInitialState:指定命令列表的渲染流水线初始状态，一般可以设置为<code>nullptr</code></li>
<li>riid:待创建的<code>ID3D12CommandList</code>接口的<code>COM ID</code></li>
<li>ppCommandList:输出指向所建命令列表的指针</li>
</ol>
<h6 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h6><ul>
<li>可以创建多个关联同一个命令分配器的命令列表</li>
<li>但是不能同时用他们记录命令</li>
<li>其中一个命令列表在记录命令时，必须关闭同一分配器的其他命令列表</li>
<li>要保证命令列表中的所有命令都会按顺序连续的添加到命令分配器内</li>
<li>当创建或重置一个命令列表时，它会处于“<em><strong>打开</strong></em> ”状态，所以同时为同一命令列表分配器创建两个命令列表会报错</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ID3D12CommandQueue::<span class="built_in">ExecuteCommandList</span>(C)；<span class="comment">//把命令添加到命令列表</span></span><br><span class="line">    <span class="comment">/*将命令列表恢复到初始状态，借此继续复用其底层内存；</span></span><br><span class="line"><span class="comment">    重置列表不会影响命令队列的命令，内存分配器在当中维护</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    ID3D12GraphicsCommandLIst::<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//GPU提交了一整帧的渲染命令后，我们可能还要为了绘制下一帧服用命令分配器的内存</span></span><br><span class="line"><span class="comment">//注意：在没有确定GPU执行完命令分配器的所有命令之前，千万不要重置命令分配器</span></span><br><span class="line">ID3D12CommandAllocator::<span class="built_in">Reset</span>();</span><br></pre></td></tr></table></figure>

<h5 id="GPU与CPU的同步"><a href="#GPU与CPU的同步" class="headerlink" title="GPU与CPU的同步"></a>GPU与CPU的同步</h5><p><strong>刷新命令队列</strong>：CPU会等待GPU完成所有命令处理，直到到达指定的***围栏点(fence point)***为止。</p>
<p>创建围栏</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT <span class="title">ID3D12Device::CreateFence</span><span class="params">(UINT64 InitialValue,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  D3D12_FENSE_FLAGS Flags,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">void</span>** ppFence)</span></span>;</span><br><span class="line"><span class="comment">//示例</span></span><br><span class="line"> Microsoft::WRL::ComPtr&lt;ID3D12Fence&gt; mFence;</span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateFence</span>(<span class="number">0</span>, D3D12_FENCE_FLAG_NONE,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(&amp;mFence)));</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::FlushCommandQueue</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 增加围栏值，接下来将命令标记到此围栏点</span></span><br><span class="line">    mCurrentFence++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 向命令队列添加一条用来设置新围栏点的命令</span></span><br><span class="line">    <span class="comment">//由于这条命令有交给GPU处理，所以在GPU处理完命令队列中此Signal()的所有命令之前</span></span><br><span class="line">    <span class="comment">//它不会设置新的围栏点</span></span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(mCommandQueue-&gt;<span class="built_in">Signal</span>(mFence.<span class="built_in">Get</span>(), mCurrentFence));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 在CPU等待GPU，直到后者执行完这个围栏点之前的所有命令</span></span><br><span class="line">    <span class="keyword">if</span>(mFence-&gt;<span class="built_in">GetCompletedValue</span>() &lt; mCurrentFence)</span><br><span class="line">	&#123;</span><br><span class="line">		HANDLE eventHandle = <span class="built_in">CreateEventEx</span>(<span class="literal">nullptr</span>, <span class="literal">false</span>, <span class="literal">false</span>, EVENT_ALL_ACCESS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若GPU命令中当前的围栏点（即执行到Signal()指令，修改了围栏点），则激发预定事件 </span></span><br><span class="line">        <span class="built_in">ThrowIfFailed</span>(mFence-&gt;<span class="built_in">SetEventOnCompletion</span>(mCurrentFence, eventHandle));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 等待GPU命中围栏，激发事件</span></span><br><span class="line">		<span class="built_in">WaitForSingleObject</span>(eventHandle, INFINITE);</span><br><span class="line">        <span class="built_in">CloseHandle</span>(eventHandle);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="资源转换"><a href="#资源转换" class="headerlink" title="资源转换"></a>资源转换</h5><p><strong>资源冒险</strong>：当GPU的写操作还没有完成或者还没有开始，却开始读取资源的情况</p>
<p>为了解决资源冒险问题，Direct3D设计了一组相关状态，如资源在创建的时候会初一默认状态，直到应用程序通过方法将其转换为另一种状态。</p>
<p><strong>转换资源屏障(<em>transition resource barrier</em></strong>):通过一个API调用来转换多个资源要用到的数组</p>
<h3 id="初始化Direct3D"><a href="#初始化Direct3D" class="headerlink" title="初始化Direct3D"></a>初始化Direct3D</h3><ul>
<li>初始化流程</li>
</ul>
<ol>
<li>用<code>D3D12CreateDevice</code>函数创建<code>ID3D12Device</code>接口实例</li>
<li>创建一个<code>ID3D12Fence</code>对象，并且查询描述符的大小</li>
<li>检测用户设备对<code>4X MSAA</code>质量级别的支持情况</li>
<li>一次创建命令队列、命令列表分配器和主命令列表</li>
<li>描述并创建交换链</li>
<li>创建应用程序所需的描述符堆</li>
<li>调整后台缓冲区的大小，并为它创建渲染图标视图</li>
<li>创建深度/模板缓冲区及与之关联的深度/模板视图</li>
<li>设置视口(viewport)和裁剪矩形(scissor rectangle)</li>
</ol>
<h5 id="创建设备"><a href="#创建设备" class="headerlink" title="创建设备"></a>创建设备</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">HRESULT WINAPI <span class="title">D3D12CreateDevice</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_opt_ IUnknown* pAdapter,</span></span></span><br><span class="line"><span class="params"><span class="function">    D3D_FEATURE_LEVEL MinimumFeatureLevel,</span></span></span><br><span class="line"><span class="params"><span class="function">    _In_ REFIID riid, <span class="comment">// Expected: ID3D12Device</span></span></span></span><br><span class="line"><span class="params"><span class="function">    _COM_Outptr_opt_ <span class="keyword">void</span>** ppDevice )</span></span>;</span><br></pre></td></tr></table></figure>

<p>案例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Try to create hardware device.</span></span><br><span class="line">HRESULT hardwareResult = <span class="built_in">D3D12CreateDevice</span>(</span><br><span class="line">	<span class="literal">nullptr</span>,             <span class="comment">// default adapter</span></span><br><span class="line">	D3D_FEATURE_LEVEL_11_0,</span><br><span class="line">	<span class="built_in">IID_PPV_ARGS</span>(&amp;md3dDevice));</span><br></pre></td></tr></table></figure>

<ol>
<li><code>pAdapte</code>r:使用的显示适配器，如果空，则使用主显示适配器</li>
<li><code>MinimumFeatureLevele</code>:应用程序需要硬件所支持的最低功能级别，如果适配器不支持此功能级别，则设备创建失败</li>
<li><code>riid</code>:<code>ID3D12Device</code>接口的COM ID</li>
<li><code>ppDevice</code>:返回创建的Direct3D 12设备</li>
</ol>
<blockquote>
<p>创建失败的话会尝试创建<code>WARP</code>设备</p>
</blockquote>
<h5 id="创建围栏"><a href="#创建围栏" class="headerlink" title="创建围栏"></a>创建围栏</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateFence</span>(<span class="number">0</span>, D3D12_FENCE_FLAG_NONE,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(&amp;mFence)));</span><br><span class="line"><span class="comment">//查询并保存描述符信息，方便后面使用</span></span><br><span class="line">	mRtvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_RTV);</span><br><span class="line">	mDsvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_DSV);</span><br><span class="line">	mCbvSrvUavDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV);</span><br></pre></td></tr></table></figure>

<h5 id="检测4X-MSAA支持"><a href="#检测4X-MSAA支持" class="headerlink" title="检测4X MSAA支持"></a>检测4X MSAA支持</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// Check 4X MSAA quality support for our back buffer format.</span></span><br><span class="line">   <span class="comment">// All Direct3D 11 capable devices support 4X MSAA for all render </span></span><br><span class="line">   <span class="comment">// target formats, so we only need to check quality support.</span></span><br><span class="line"></span><br><span class="line">D3D12_FEATURE_DATA_MULTISAMPLE_QUALITY_LEVELS msQualityLevels;</span><br><span class="line">msQualityLevels.Format = mBackBufferFormat;</span><br><span class="line">msQualityLevels.SampleCount = <span class="number">4</span>;</span><br><span class="line">msQualityLevels.Flags = D3D12_MULTISAMPLE_QUALITY_LEVELS_FLAG_NONE;</span><br><span class="line">msQualityLevels.NumQualityLevels = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CheckFeatureSupport</span>(</span><br><span class="line">	D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS,</span><br><span class="line">	&amp;msQualityLevels,</span><br><span class="line">	<span class="built_in"><span class="keyword">sizeof</span></span>(msQualityLevels)));</span><br><span class="line"></span><br><span class="line">   m4xMsaaQuality = msQualityLevels.NumQualityLevels;</span><br><span class="line"><span class="built_in">assert</span>(m4xMsaaQuality &gt; <span class="number">0</span> &amp;&amp; <span class="string">&quot;Unexpected MSAA quality level.&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="创建命令队列和命令列表"><a href="#创建命令队列和命令列表" class="headerlink" title="创建命令队列和命令列表"></a>创建命令队列和命令列表</h5><ul>
<li><p>命令队列：<code>ID3D12CommandQueue</code></p>
</li>
<li><p>命令分配器：<code>ID3D12CommandAllocator</code></p>
</li>
<li><p>命令列表：<code>ID3D12GraphicsCommandList</code></p>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.h申明</span></span><br><span class="line">Microsoft::WRL::ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12GraphicsCommandList&gt; mCommandList;</span><br><span class="line"><span class="comment">//.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateCommandObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">	queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line">	queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;mCommandQueue)));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandList</span>(</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		D3D12_COMMAND_LIST_TYPE_DIRECT,</span><br><span class="line">		mDirectCmdListAlloc.<span class="built_in">Get</span>(), <span class="comment">// 关联的命令分配器</span></span><br><span class="line">		<span class="literal">nullptr</span>,                   <span class="comment">//初始的PipelineStateObject</span></span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mCommandList.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line"><span class="comment">//从关闭状态开始。 这是因为我们第一次提到</span></span><br><span class="line"><span class="comment">//在命令列表中，我们将对其进行重置，并且需要先关闭它</span></span><br><span class="line"><span class="comment">//调用Reset。</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">Close</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="创建交换链"><a href="#创建交换链" class="headerlink" title="创建交换链"></a>创建交换链</h5><ul>
<li><code>DXGI_SWAP_CHAIN_DESC</code>结构体定义</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_SWAP_CHAIN_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    DXGI_MODE_DESC BufferDesc;</span><br><span class="line">    DXGI_SAMPLE_DESC SampleDesc;</span><br><span class="line">    DXGI_USAGE BufferUsage;</span><br><span class="line">    UINT BufferCount;</span><br><span class="line">    HWND OutputWindow;</span><br><span class="line">    BOOL Windowed;</span><br><span class="line">    DXGI_SWAP_EFFECT SwapEffect;</span><br><span class="line">    UINT Flags;</span><br><span class="line">    &#125; 	DXGI_SWAP_CHAIN_DESC;</span><br></pre></td></tr></table></figure>

<ol>
<li>BufferDesc:后台缓冲区的属性，主要是高度、宽度和像素格式</li>
<li>SampleDesc：多重采样的质量级别以及对每个像素的采样次数</li>
<li>BufferUsage：如果要将数据渲染到后台缓冲区，则设置为<code>DXGI_USAGE_RENDER_TARGET_OUTPUT</code></li>
<li>BufferCount:缓冲区数量，指定为2即双缓冲</li>
<li>OutputWindow：渲染窗口的句柄</li>
<li>Windowed：true则窗口模式运行，否则全屏</li>
<li>SwapEffect：指定为<code>DXGI_SWAP_EFFECT_FLIP_DISCARD</code></li>
<li>Flags：可选；如果指定为<code>DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH</code>则程序切换为全屏时，将选择适用于当前窗口尺寸的显示模式；否则就采用当前桌面的显示模式</li>
</ol>
<ul>
<li><code>DXGI_MODE_DESC</code></li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DXGI_MODE_DESC</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    UINT Width;<span class="comment">//缓冲区分辨率的宽度</span></span><br><span class="line">    UINT Height;<span class="comment">//高度</span></span><br><span class="line">    DXGI_RATIONAL RefreshRate;</span><br><span class="line">    DXGI_FORMAT Format;<span class="comment">//显示格式</span></span><br><span class="line">    DXGI_MODE_SCANLINE_ORDER ScanlineOrdering;<span class="comment">//逐行扫面vs.隔行扫描</span></span><br><span class="line">    DXGI_MODE_SCALING Scaling;<span class="comment">//如何进行拉升</span></span><br><span class="line">&#125; DXGI_MODE_DESC;</span><br></pre></td></tr></table></figure>

<h6 id="执行创建交换链"><a href="#执行创建交换链" class="headerlink" title="执行创建交换链"></a>执行创建交换链</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateSwapChain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 释放我们将重新创建的先前的交换链。</span></span><br><span class="line">    mSwapChain.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">    DXGI_SWAP_CHAIN_DESC sd;</span><br><span class="line">    sd.BufferDesc.Width = mClientWidth;</span><br><span class="line">    sd.BufferDesc.Height = mClientHeight;</span><br><span class="line">    sd.BufferDesc.RefreshRate.Numerator = <span class="number">60</span>;</span><br><span class="line">    sd.BufferDesc.RefreshRate.Denominator = <span class="number">1</span>;</span><br><span class="line">    sd.BufferDesc.Format = mBackBufferFormat;</span><br><span class="line">    sd.BufferDesc.ScanlineOrdering = DXGI_MODE_SCANLINE_ORDER_UNSPECIFIED;</span><br><span class="line">    sd.BufferDesc.Scaling = DXGI_MODE_SCALING_UNSPECIFIED;</span><br><span class="line">    sd.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">    sd.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">    sd.BufferUsage = DXGI_USAGE_RENDER_TARGET_OUTPUT;</span><br><span class="line">    sd.BufferCount = SwapChainBufferCount;</span><br><span class="line">    sd.OutputWindow = mhMainWnd;</span><br><span class="line">    sd.Windowed = <span class="literal">true</span>;</span><br><span class="line">	sd.SwapEffect = DXGI_SWAP_EFFECT_FLIP_DISCARD;</span><br><span class="line">    sd.Flags = DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Note: 交换链使用队列执行刷新。</span></span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(mdxgiFactory-&gt;<span class="built_in">CreateSwapChain</span>(</span><br><span class="line">		mCommandQueue.<span class="built_in">Get</span>(),</span><br><span class="line">		&amp;sd, </span><br><span class="line">		mSwapChain.<span class="built_in">GetAddressOf</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="创建描述符堆"><a href="#创建描述符堆" class="headerlink" title="创建描述符堆"></a>创建描述符堆</h5><p>创建描述符堆来存储程序中要用到的<strong>描述符/视图</strong>，本例中需要创建两个描述符堆来存储<code>SwapChainBufferCount</code>个<code>RTV</code> ,另外一个存储1个<code>DSV</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.h</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mRtvHeap;</span><br><span class="line">    Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mDsvHeap;</span><br><span class="line"><span class="comment">//.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">D3DApp::CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    D3D12_DESCRIPTOR_HEAP_DESC rtvHeapDesc;</span><br><span class="line">    rtvHeapDesc.NumDescriptors = SwapChainBufferCount;<span class="comment">//static value=2</span></span><br><span class="line">    rtvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_RTV;</span><br><span class="line">    rtvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	rtvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(</span><br><span class="line">        &amp;rtvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(mRtvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    D3D12_DESCRIPTOR_HEAP_DESC dsvHeapDesc;</span><br><span class="line">    dsvHeapDesc.NumDescriptors = <span class="number">1</span>;</span><br><span class="line">    dsvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_DSV;</span><br><span class="line">    dsvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	dsvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(</span><br><span class="line">        &amp;dsvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(mDsvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建以后需要通过方法来获得描述符的句柄</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">D3DApp::CurrentBackBufferView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//构造函数根据给定的偏移量找到当前后台缓冲区的RTV</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">CD3DX12_CPU_DESCRIPTOR_HANDLE</span>(</span><br><span class="line">		mRtvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>(),<span class="comment">//堆中的首个句柄</span></span><br><span class="line">		mCurrBackBuffer,<span class="comment">//偏移至后台缓冲区描述符句柄的索引</span></span><br><span class="line">		mRtvDescriptorSize);<span class="comment">//描述符所占字节大小</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">D3DApp::DepthStencilView</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mDsvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="创建渲染目标视图"><a href="#创建渲染目标视图" class="headerlink" title="创建渲染目标视图"></a>创建渲染目标视图</h5><blockquote>
<p>资源不能与渲染流水线中的阶段直接绑定，所以必须先为资源创建视图（描述符），并将其绑定到流水线阶段</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> HRESULT STDMETHODCALLTYPE <span class="title">GetBuffer</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="comment">/* [in] */</span> UINT Buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="comment">/* [annotation][in] */</span> </span></span></span><br><span class="line"><span class="params"><span class="function">           _In_  REFIID riid,</span></span></span><br><span class="line"><span class="params"><span class="function">           <span class="comment">/* [annotation][out][in] */</span> </span></span></span><br><span class="line"><span class="params"><span class="function">           _COM_Outptr_  <span class="keyword">void</span> **ppSurface)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>Buffer:后台缓冲区索引</li>
<li>riid:COM ID</li>
<li>ppSurface:返回<code>ID3D12Resource</code>接口的指针，即后台缓冲区</li>
</ol>
<blockquote>
<p>调用此方法后会增加计数，所以使用后需要释放，需通过ComPtr</p>
</blockquote>
<p>然后获得后台缓冲区创建的渲染目标视图</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> STDMETHODCALLTYPE <span class="title">CreateRenderTargetView</span><span class="params">( </span></span></span><br><span class="line"><span class="params"><span class="function">           _In_opt_  ID3D12Resource *pResource,</span></span></span><br><span class="line"><span class="params"><span class="function">           _In_opt_  <span class="keyword">const</span> D3D12_RENDER_TARGET_VIEW_DESC *pDesc,</span></span></span><br><span class="line"><span class="params"><span class="function">           _In_  D3D12_CPU_DESCRIPTOR_HANDLE DestDescriptor)</span> </span>= <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<ol>
<li>pResource:指定用作渲染目标的资源</li>
<li>pDesc:指向<code>D3D12_RENDER_TARGET_VIEW_DESC</code>数组结构体的指针</li>
<li>DestDescriptor:引用所创建渲染目标视图的描述符句柄</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHeapHandle</span><span class="params">(mRtvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line">	<span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; SwapChainBufferCount; i++)</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="comment">//获得交换链中的第 i 个缓冲区</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mSwapChain-&gt;<span class="built_in">GetBuffer</span>(i, <span class="built_in">IID_PPV_ARGS</span>(&amp;mSwapChainBuffer[i])));</span><br><span class="line">        <span class="comment">//为此缓冲区创建一个RTV</span></span><br><span class="line">		md3dDevice-&gt;<span class="built_in">CreateRenderTargetView</span>(mSwapChainBuffer[i].<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, rtvHeapHandle);</span><br><span class="line">        <span class="comment">//偏移到下一个缓冲区</span></span><br><span class="line">		rtvHeapHandle.<span class="built_in">Offset</span>(<span class="number">1</span>, mRtvDescriptorSize);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<h5 id="创建深度-模板缓冲区及其视图"><a href="#创建深度-模板缓冲区及其视图" class="headerlink" title="创建深度/模板缓冲区及其视图"></a>创建深度/模板缓冲区及其视图</h5><p>因为深度缓冲区就是一种2D纹理，所以我们通过填写<code>D3D12_RESOURCE_DESC</code>结构体来描述纹理资源</p>
<p>再用<code>ID3D12Device::CreateCommittedResource</code>方法来创建它</p>
<ul>
<li>D3D12_RESOURCE_DESC</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_RESOURCE_DESC</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_RESOURCE_DIMENSION Dimension;</span><br><span class="line">    UINT64 Alignment;</span><br><span class="line">    UINT64 Width;</span><br><span class="line">    UINT Height;</span><br><span class="line">    UINT16 DepthOrArraySize;</span><br><span class="line">    UINT16 MipLevels;</span><br><span class="line">    DXGI_FORMAT Format;</span><br><span class="line">    DXGI_SAMPLE_DESC SampleDesc;</span><br><span class="line">    D3D12_TEXTURE_LAYOUT Layout;</span><br><span class="line">    D3D12_RESOURCE_FLAGS Flags;</span><br><span class="line">    &#125; 	D3D12_RESOURCE_DESC;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>D3D12_RESOURCE_DIMENSION Dimension：资源的维度</p>
<ol>
<li>```cpp<br>enum D3D12_RESOURCE_DIMENSION<pre><code>&#123;
    D3D12_RESOURCE_DIMENSION_UNKNOWN    = 0,
    D3D12_RESOURCE_DIMENSION_BUFFER    = 1,
    D3D12_RESOURCE_DIMENSION_TEXTURE1D    = 2,
    D3D12_RESOURCE_DIMENSION_TEXTURE2D    = 3,
    D3D12_RESOURCE_DIMENSION_TEXTURE3D    = 4
&#125;     D3D12_RESOURCE_DIMENSION;
</code></pre>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. Width:像素单位的纹理宽度。对于缓冲区，此项是占用的字节数</span><br><span class="line"></span><br><span class="line">3. Height:同上</span><br><span class="line"></span><br><span class="line">4. DepthOrArraySize:纹素为单位的纹理深度，或者是纹理数组的大小</span><br><span class="line"></span><br><span class="line">5. MipLevels：mipmap层级的数量</span><br><span class="line"></span><br><span class="line">6. Format:DXGI_FORMAT枚举成员之一</span><br><span class="line"></span><br><span class="line">7. SampleDesc：多重采样级别和每个像素的采样次数</span><br><span class="line"></span><br><span class="line">8. Layout：D3D12_TEXTURE_LAYOUT枚举成员之一，用于指定纹理布局</span><br><span class="line"></span><br><span class="line">9. Flags：杂项标记，对于深度/模板缓冲区资源，设置为`D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; `GPU`资源都存储在`堆`中，本质是具有特定属性的`GPU`显存快</span><br><span class="line">&gt;</span><br><span class="line">&gt; `ID3D12Device::CreateCommitedResource`方法根据提供的属性创建一个资源和一个堆，把资源提交到这个堆</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###### CreateCommittedResource</span><br><span class="line"></span><br><span class="line">```cpp</span><br><span class="line">virtual HRESULT STDMETHODCALLTYPE CreateCommittedResource( </span><br><span class="line">            _In_  const D3D12_HEAP_PROPERTIES *pHeapProperties,//资源提交到的堆的属性，见下</span><br><span class="line">            D3D12_HEAP_FLAGS HeapFlags,//额外标记，一般是D3D12_HEAP_FLAG_NONE</span><br><span class="line">            _In_  const D3D12_RESOURCE_DESC *pDesc,//描述待创建的资源</span><br><span class="line">            D3D12_RESOURCE_STATES InitialResourceState,//此参数来设置资源的初始状态</span><br><span class="line">            _In_opt_  const D3D12_CLEAR_VALUE *pOptimizedClearValue,//清楚资源的优化值，不需要就选择nullptr</span><br><span class="line">            REFIID riidResource,//COM ID</span><br><span class="line">            _COM_Outptr_opt_  void **ppvResource) = 0;//新创建的资源，指向ID3D12Resource的指针</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<h6 id="D3D12-HEAP-PROPERTIES"><a href="#D3D12-HEAP-PROPERTIES" class="headerlink" title="D3D12_HEAP_PROPERTIES"></a>D3D12_HEAP_PROPERTIES</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_HEAP_PROPERTIES</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    D3D12_HEAP_TYPE Type;</span><br><span class="line">    D3D12_CPU_PAGE_PROPERTY CPUPageProperty;</span><br><span class="line">    D3D12_MEMORY_POOL MemoryPoolPreference;</span><br><span class="line">    UINT CreationNodeMask;</span><br><span class="line">    UINT VisibleNodeMask;</span><br><span class="line">    &#125; 	D3D12_HEAP_PROPERTIES;</span><br></pre></td></tr></table></figure>

<h6 id="D3D12-HEAP-TYPE"><a href="#D3D12-HEAP-TYPE" class="headerlink" title="D3D12_HEAP_TYPE"></a>D3D12_HEAP_TYPE</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">D3D12_HEAP_TYPE</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        D3D12_HEAP_TYPE_DEFAULT	= <span class="number">1</span>,<span class="comment">//默认堆</span></span><br><span class="line">        D3D12_HEAP_TYPE_UPLOAD	= <span class="number">2</span>,<span class="comment">//上传堆</span></span><br><span class="line">        D3D12_HEAP_TYPE_READBACK	= <span class="number">3</span>,<span class="comment">//回读堆</span></span><br><span class="line">        D3D12_HEAP_TYPE_CUSTOM	= <span class="number">4</span><span class="comment">//高级场景使用</span></span><br><span class="line">    &#125; 	D3D12_HEAP_TYPE;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// Create the depth/stencil buffer and view.</span></span><br><span class="line">  D3D12_RESOURCE_DESC depthStencilDesc;</span><br><span class="line">  depthStencilDesc.Dimension = D3D12_RESOURCE_DIMENSION_TEXTURE2D;</span><br><span class="line">  depthStencilDesc.Alignment = <span class="number">0</span>;</span><br><span class="line">  depthStencilDesc.Width = mClientWidth;</span><br><span class="line">  depthStencilDesc.Height = mClientHeight;</span><br><span class="line">  depthStencilDesc.DepthOrArraySize = <span class="number">1</span>;</span><br><span class="line">  depthStencilDesc.MipLevels = <span class="number">1</span>;</span><br><span class="line">  depthStencilDesc.Format = mDepthStencilFormat;</span><br><span class="line">  depthStencilDesc.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">  depthStencilDesc.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">  depthStencilDesc.Layout = D3D12_TEXTURE_LAYOUT_UNKNOWN;</span><br><span class="line">  depthStencilDesc.Flags = D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL;</span><br><span class="line"></span><br><span class="line">  D3D12_CLEAR_VALUE optClear;</span><br><span class="line">  optClear.Format = mDepthStencilFormat;</span><br><span class="line">  optClear.DepthStencil.Depth = <span class="number">1.0f</span>;</span><br><span class="line">  optClear.DepthStencil.Stencil = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">      &amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT),</span><br><span class="line">D3D12_HEAP_FLAG_NONE,</span><br><span class="line">      &amp;depthStencilDesc,</span><br><span class="line">D3D12_RESOURCE_STATE_COMMON,</span><br><span class="line">      &amp;optClear,</span><br><span class="line">      <span class="built_in">IID_PPV_ARGS</span>(mDepthStencilBuffer.<span class="built_in">GetAddressOf</span>())));</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">// 使用资源格式将描述符创建为整个资源的MIP级别0。</span></span><br><span class="line">   md3dDevice-&gt;<span class="built_in">CreateDepthStencilView</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, <span class="built_in">DepthStencilView</span>());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 将资源从其初始状态转换为深度缓冲区。</span></span><br><span class="line">mCommandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>, &amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(),</span><br><span class="line">	D3D12_RESOURCE_STATE_COMMON, D3D12_RESOURCE_STATE_DEPTH_WRITE));</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="设置视口"><a href="#设置视口" class="headerlink" title="设置视口"></a>设置视口</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D3D12_VIEWPORT mScreenViewport; </span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">D3D12_VIEWPORT</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">    FLOAT TopLeftX;</span><br><span class="line">    FLOAT TopLeftY;</span><br><span class="line">    FLOAT Width;</span><br><span class="line">    FLOAT Height;</span><br><span class="line">    FLOAT MinDepth;<span class="comment">//负责从区间0-1转化为MinDepth-MaxDepth</span></span><br><span class="line">    FLOAT MaxDepth;</span><br><span class="line">    &#125; 	D3D12_VIEWPORT;</span><br></pre></td></tr></table></figure>



<p>填好结构体以后通过函数<code>ID3D12GraphicsCommandList::RSSetViewports</code>方法来设置视口</p>
<h6 id="示例-1"><a href="#示例-1" class="headerlink" title="示例"></a>示例</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mScreenViewport.TopLeftX = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.TopLeftY = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.Width    = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientWidth);</span><br><span class="line">	mScreenViewport.Height   = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientHeight);</span><br><span class="line">	mScreenViewport.MinDepth = <span class="number">0.0f</span>;</span><br><span class="line">	mScreenViewport.MaxDepth = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> mCommandList-&gt;<span class="built_in">RSSetViewports</span>(<span class="number">1</span>, &amp;mScreenViewport);</span><br></pre></td></tr></table></figure>



<blockquote>
<p>不能为同一个渲染目标指定多个视口</p>
<p>而多个视口则是一种用于对多个渲染目标同时进行渲染的高级技术</p>
<p>命令列表重置，视口也要重置</p>
</blockquote>
<h5 id="设置裁剪矩形"><a href="#设置裁剪矩形" class="headerlink" title="设置裁剪矩形"></a>设置裁剪矩形</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagRECT</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    LONG    left;</span><br><span class="line">    LONG    top;</span><br><span class="line">    LONG    right;</span><br><span class="line">    LONG    bottom;</span><br><span class="line">&#125; RECT, *PRECT, NEAR *NPRECT, FAR *LPRECT;</span><br></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mScissorRect = &#123; <span class="number">0</span>, <span class="number">0</span>, mClientWidth, mClientHeight &#125;;</span><br><span class="line"></span><br><span class="line">mCommandList-&gt;<span class="built_in">RSSetScissorRects</span>(<span class="number">1</span>, &amp;mScissorRect);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不能为同一个渲染目标指定多个裁剪矩形。</p>
<p>多裁剪矩形是以各种用于同时对多个渲染目标进行渲染的高级技术</p>
<p>裁剪矩形需要随着命令列表重置而重置</p>
</blockquote>
<h3 id="计时与动画"><a href="#计时与动画" class="headerlink" title="计时与动画"></a>计时与动画</h3><h5 id="性能计时器"><a href="#性能计时器" class="headerlink" title="性能计时器"></a>性能计时器</h5><p><code>QueryPerformanceCounter</code>函数来活得性能计时器测量的当前时刻值</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__int64 countsPerSec;</span><br><span class="line">	<span class="built_in">QueryPerformanceFrequency</span>((LARGE_INTEGER*)&amp;countsPerSec);</span><br><span class="line">	mSecondsPerCount = <span class="number">1.0</span> / (<span class="keyword">double</span>)countsPerSec;</span><br></pre></td></tr></table></figure>

<p>通过如下方式转换为秒</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">valueInSecs=valueInCounts * mSecondsPercount;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>调用2次<code>QueryPerformanceCounter</code>函数得到两个时间戳的相对插值</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 A;</span><br><span class="line">	<span class="built_in">QueryPerformanceFrequency</span>((LARGE_INTEGER*)&amp;A);</span><br><span class="line">__int64 B;</span><br><span class="line">	<span class="built_in">QueryPerformanceFrequency</span>((LARGE_INTEGER*)&amp;B);</span><br></pre></td></tr></table></figure>

<p><code>B-A</code>即可获得执行期间的计数值，或者<code>(B-1)*mSecondsPerCount</code>获得代码运行期间所花费的秒数</p>
<h5 id="游戏计时器类"><a href="#游戏计时器类" class="headerlink" title="游戏计时器类"></a>游戏计时器类</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GameTimer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">GameTimer</span>();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">TotalTime</span><span class="params">()</span><span class="keyword">const</span></span>; <span class="comment">//秒为单位</span></span><br><span class="line">	<span class="function"><span class="keyword">float</span> <span class="title">DeltaTime</span><span class="params">()</span><span class="keyword">const</span></span>; <span class="comment">//秒为单位</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Reset</span><span class="params">()</span></span>; <span class="comment">// 开始循环之前调用</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Start</span><span class="params">()</span></span>; <span class="comment">// 接触计时器暂停时调用</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Stop</span><span class="params">()</span></span>;  <span class="comment">// 暂停计时器调用</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Tick</span><span class="params">()</span></span>;  <span class="comment">//每帧都要调用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">double</span> mSecondsPerCount;</span><br><span class="line">	<span class="keyword">double</span> mDeltaTime;</span><br><span class="line"></span><br><span class="line">	__int64 mBaseTime;</span><br><span class="line">	__int64 mPausedTime;</span><br><span class="line">	__int64 mStopTime;</span><br><span class="line">	__int64 mPrevTime;</span><br><span class="line">	__int64 mCurrTime;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">bool</span> mStopped;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="帧与帧之间的时间间隔"><a href="#帧与帧之间的时间间隔" class="headerlink" title="帧与帧之间的时间间隔"></a>帧与帧之间的时间间隔</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameTimer::Tick</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>( mStopped )</span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime = <span class="number">0.0</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// 获得本帧开始的时刻</span></span><br><span class="line">	__int64 currTime;</span><br><span class="line">	<span class="built_in">QueryPerformanceCounter</span>((LARGE_INTEGER*)&amp;currTime);</span><br><span class="line">	mCurrTime = currTime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 两帧的时间差</span></span><br><span class="line">	mDeltaTime = (mCurrTime - mPrevTime)*mSecondsPerCount;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 把当前时间设置为下一次的开始时间</span></span><br><span class="line">	mPrevTime = mCurrTime;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//保证时间差为非负值；</span></span><br><span class="line">    <span class="comment">//在处理器处于节能模式或者计算两次时间差的过程中切换到了另一个处理器可能会得到负值</span></span><br><span class="line">	<span class="keyword">if</span>(mDeltaTime &lt; <span class="number">0.0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		mDeltaTime = <span class="number">0.0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>次<code>Tick</code>函数被调用在<code>D3DApp::Run</code>函数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">D3DApp::Run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MSG msg = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"> </span><br><span class="line">	mTimer.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(msg.message != WM_QUIT)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If there are Window messages then process them.</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="built_in">PeekMessage</span>( &amp;msg, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE ))</span><br><span class="line">		&#123;</span><br><span class="line">            <span class="built_in">TranslateMessage</span>( &amp;msg );</span><br><span class="line">            <span class="built_in">DispatchMessage</span>( &amp;msg );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Otherwise, do animation/game stuff.</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">        &#123;	</span><br><span class="line">			mTimer.<span class="built_in">Tick</span>();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span>( !mAppPaused )</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">CalculateFrameStats</span>();</span><br><span class="line">				<span class="built_in">Update</span>(mTimer);	</span><br><span class="line">                <span class="built_in">Draw</span>(mTimer);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">100</span>);</span><br><span class="line">			&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">int</span>)msg.wParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Reset</code>方法初始化第一帧的数据，因为第一帧没有之前的帧</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">GameTimer::Reset</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__int64 currTime;</span><br><span class="line">	<span class="built_in">QueryPerformanceCounter</span>((LARGE_INTEGER*)&amp;currTime);</span><br><span class="line"></span><br><span class="line">	mBaseTime = currTime;</span><br><span class="line">	mPrevTime = currTime;</span><br><span class="line">	mStopTime = <span class="number">0</span>;</span><br><span class="line">	mStopped  = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="总时间"><a href="#总时间" class="headerlink" title="总时间"></a>总时间</h5><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">GameTimer::TotalTime</span><span class="params">()</span><span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果我们停止了，请勿计算自停止以来经过的时间。</span></span><br><span class="line">    <span class="comment">//此外，如果我们之前已经停顿了一下</span></span><br><span class="line">    <span class="comment">// mStopTime-mBaseTime包含暂停时间，我们不想计算。</span></span><br><span class="line">    <span class="comment">//要纠正此问题，我们可以从mStopTime中减去暂停时间： </span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//                     |&lt;--paused time--&gt;|</span></span><br><span class="line">	<span class="comment">// ----*---------------*-----------------*------------*------------*------&gt; time</span></span><br><span class="line">	<span class="comment">//  mBaseTime       mStopTime        startTime     mStopTime    mCurrTime</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>( mStopped )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">float</span>)(((mStopTime - mPausedTime)-mBaseTime)*mSecondsPerCount);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//距离mCurrTime-mBaseTime包括暂停时间，</span></span><br><span class="line">    <span class="comment">//我们不想计算。 要纠正这一点，我们可以减去</span></span><br><span class="line">    <span class="comment">//从mCurrTime暂停的时间： </span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  (mCurrTime - mPausedTime) - mBaseTime </span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//                     |&lt;--paused time--&gt;|</span></span><br><span class="line">	<span class="comment">// ----*---------------*-----------------*------------*------&gt; time</span></span><br><span class="line">	<span class="comment">//  mBaseTime       mStopTime        startTime     mCurrTime</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in"><span class="keyword">return</span></span> (<span class="keyword">float</span>)(((mCurrTime-mPausedTime)-mBaseTime)*mSecondsPerCount);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="应用程序框架示例"><a href="#应用程序框架示例" class="headerlink" title="应用程序框架示例"></a>应用程序框架示例</h3><p>自己模仿框架的代码</p>
<h6 id="DXApp-h"><a href="#DXApp-h" class="headerlink" title="DXApp.h"></a>DXApp.h</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> once</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/d3dUtil.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/d3dx12.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../Common/GameTimer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(DEBUG) || defined(_DEBUG)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRTDBG_MAP_ALLOC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;crtdbg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dxgiformat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Link necessary d3d12 libraries.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib,<span class="meta-string">&quot;d3dcompiler.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;D3D12.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> comment(lib, <span class="meta-string">&quot;dxgi.lib&quot;</span>)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DXApp</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DXApp</span>(HINSTANCE nInstance);</span><br><span class="line">	<span class="built_in">DXApp</span>(<span class="keyword">const</span> DXApp&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">	DXApp&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> DXApp&amp; rhs) = <span class="keyword">delete</span>;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">DXApp</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnResize</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">bool</span> <span class="title">Initialize</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span>;<span class="comment">//创建描述符堆</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Update</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span> </span>= <span class="number">0</span>;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Draw</span><span class="params">(<span class="keyword">const</span> GameTimer&amp; gt)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitMainWindow</span><span class="params">()</span></span>;<span class="comment">//初始化窗口</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">InitDirect3D</span><span class="params">()</span></span>;<span class="comment">//初始化DX</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">FlushCommandQueue</span><span class="params">()</span></span>;<span class="comment">//齐平命令队列</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CreateSwapChain</span><span class="params">()</span></span>;<span class="comment">//创建交换链</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CreateCommandObjects</span><span class="params">()</span></span>;<span class="comment">//创建命令队列、命令适配器、命令列表</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function">ID3D12Resource* <span class="title">CurrentBackBuffer</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">CurrentBackBufferView</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line">	<span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">DepthStencilView</span><span class="params">()</span><span class="keyword">const</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LogAdapters</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LogAdapterOutputs</span><span class="params">(IDXGIAdapter* adapter)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">LogOutputDisplayModes</span><span class="params">(IDXGIOutput* output, DXGI_FORMAT format)</span></span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">static</span> DXApp* <span class="title">GetApp</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">HINSTANCE <span class="title">AppInst</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//得到应用程序实例</span></span><br><span class="line">	<span class="function">HWND      <span class="title">MainWnd</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//得到窗口</span></span><br><span class="line">	<span class="function"><span class="keyword">float</span>     <span class="title">AspectRatio</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//长宽比</span></span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">Get4xMsaaState</span><span class="params">()</span><span class="keyword">const</span></span>;<span class="comment">//4XMSAA开启与否</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Set4xMsaaState</span><span class="params">(<span class="keyword">bool</span> value)</span></span>;<span class="comment">//设置4XMSAA</span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">Run</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">CalculateFrameStats</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	HWND hwnd; //窗口句柄 </span></span><br><span class="line"><span class="comment">	UINT message; //消息常量标识符 </span></span><br><span class="line"><span class="comment">	WPARAM wParam; //32位消息的特定附加信息,具体表示什么处决于message </span></span><br><span class="line"><span class="comment">	LPARAM lParam; //32位消息的特定附加信息,具体表示什么处决于message </span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> LRESULT <span class="title">MsgProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//鼠标输入</span></span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseDown</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseUp</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnMouseMove</span><span class="params">(WPARAM btnState, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span>:</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> DXApp* mApp;</span><br><span class="line"></span><br><span class="line">	HINSTANCE mhAppInst = <span class="literal">nullptr</span>; <span class="comment">// 应用程序实例句柄</span></span><br><span class="line">	HWND      mhMainWnd = <span class="literal">nullptr</span>; <span class="comment">// 主窗口句柄</span></span><br><span class="line">	<span class="keyword">bool</span>      mAppPaused = <span class="literal">false</span>;  <span class="comment">// 应用程序是否已暂停？</span></span><br><span class="line">	<span class="keyword">bool</span>      mMinimized = <span class="literal">false</span>;  <span class="comment">// 将应用程序最小化?</span></span><br><span class="line">	<span class="keyword">bool</span>      mMaximized = <span class="literal">false</span>;  <span class="comment">// 应用程序是否已最大化？</span></span><br><span class="line">	<span class="keyword">bool</span>      mResizing = <span class="literal">false</span>;   <span class="comment">// 是否拖动了大小调整栏？</span></span><br><span class="line">	<span class="keyword">bool</span>      mFullscreenState = <span class="literal">false</span>;<span class="comment">// 启用全屏</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 是否启用 4X MSAA (?.1.8).  The default is false.</span></span><br><span class="line">	<span class="keyword">bool</span>      m4xMsaaState = <span class="literal">false</span>;    <span class="comment">// 启用 4X MSAA </span></span><br><span class="line">	UINT      m4xMsaaQuality = <span class="number">0</span>;      <span class="comment">// 4倍MSAA的质量水平</span></span><br><span class="line"></span><br><span class="line">	GameTimer mTimer;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//COM</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Device&gt; md3dDevice; <span class="comment">//设备接口</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;IDXGIFactory4&gt; mdxgiFactory;</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;IDXGISwapChain&gt; mSwapChain;<span class="comment">//交换链</span></span><br><span class="line"></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Fence&gt; mFence;<span class="comment">//围栏</span></span><br><span class="line">	UINT64 mCurrentFence = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12CommandQueue&gt; mCommandQueue;<span class="comment">//命令队列</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12CommandAllocator&gt; mDirectCmdListAlloc;<span class="comment">//适配器</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12GraphicsCommandList&gt; mCommandList;<span class="comment">//列表</span></span><br><span class="line">	<span class="comment">//描述符</span></span><br><span class="line">	UINT mRtvDescriptorSize = <span class="number">0</span>;</span><br><span class="line">	UINT mDsvDescriptorSize = <span class="number">0</span>;</span><br><span class="line">	UINT mCbvSrvUavDescriptorSize = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> SwapChainBufferCount = <span class="number">2</span>;<span class="comment">//双重缓冲</span></span><br><span class="line">	<span class="keyword">int</span> mCurrBackBuffer = <span class="number">0</span>;</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mSwapChainBuffer[SwapChainBufferCount];<span class="comment">//交换链缓冲区数组</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12Resource&gt; mDepthStencilBuffer;<span class="comment">//深度模板缓冲区</span></span><br><span class="line">	</span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mRtvHeap;<span class="comment">//RTV描述符堆</span></span><br><span class="line">	Microsoft::WRL::ComPtr&lt;ID3D12DescriptorHeap&gt; mDsvHeap;<span class="comment">//DSV描述符堆</span></span><br><span class="line"></span><br><span class="line">	std::wstring mMainWndCaption = <span class="string">L&quot;DX App&quot;</span>;</span><br><span class="line">	D3D_DRIVER_TYPE md3dDriverType = D3D_DRIVER_TYPE_HARDWARE;</span><br><span class="line">	DXGI_FORMAT mBackBufferFormat = DXGI_FORMAT_R8G8B8A8_UNORM;</span><br><span class="line">	DXGI_FORMAT mDepthStencilFormat = DXGI_FORMAT_D24_UNORM_S8_UINT;</span><br><span class="line"></span><br><span class="line">	D3D12_VIEWPORT mScreenViewport;<span class="comment">//视口</span></span><br><span class="line">	D3D12_RECT mScissorRect;<span class="comment">//裁剪</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> mClientWidth = <span class="number">800</span>;</span><br><span class="line">	<span class="keyword">int</span> mClientHeight = <span class="number">600</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<h6 id="DXApp-cpp"><a href="#DXApp-cpp" class="headerlink" title="DXApp.cpp"></a>DXApp.cpp</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;DXApp.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;WindowsX.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;winuser.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dxgi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> Microsoft::WRL::ComPtr;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> DirectX;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DXApp* DXApp::mApp = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT CALLBACK</span></span><br><span class="line"><span class="function"><span class="title">MainWndProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//cout &lt;&lt; &quot;test&quot;;</span></span><br><span class="line">	<span class="keyword">return</span> DXApp::<span class="built_in">GetApp</span>()-&gt;<span class="built_in">MsgProc</span>(hwnd, msg, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DXApp::<span class="built_in">DXApp</span>(HINSTANCE nInstance):<span class="built_in">mhAppInst</span>(nInstance)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">assert</span>(mApp == <span class="literal">nullptr</span>);</span><br><span class="line">	mApp = <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DXApp::~<span class="built_in">DXApp</span>()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (mhAppInst != <span class="literal">nullptr</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::OnResize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">assert</span>(md3dDevice);</span><br><span class="line">	<span class="built_in">assert</span>(mSwapChain);</span><br><span class="line">	<span class="built_in">assert</span>(mDirectCmdListAlloc);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Reset</span>(mDirectCmdListAlloc.<span class="built_in">Get</span>(),<span class="literal">nullptr</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//释放我们将重新创建的先前资源。</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;SwapChainBufferCount;++i)</span><br><span class="line">	&#123;</span><br><span class="line">		mSwapChainBuffer[i].<span class="built_in">Reset</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	mDepthStencilBuffer.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">//调整交换链的大小。</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mSwapChain-&gt;<span class="built_in">ResizeBuffers</span>(</span><br><span class="line">	SwapChainBufferCount,</span><br><span class="line">	mClientWidth,</span><br><span class="line">	mClientHeight,</span><br><span class="line">	mBackBufferFormat,</span><br><span class="line">	DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH));</span><br><span class="line"></span><br><span class="line">	mCurrBackBuffer=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">CD3DX12_CPU_DESCRIPTOR_HANDLE <span class="title">rtvHeapHandle</span><span class="params">(mRtvHeap-&gt;GetCPUDescriptorHandleForHeapStart())</span></span>;</span><br><span class="line">	<span class="keyword">for</span> (UINT i = <span class="number">0</span>; i &lt; SwapChainBufferCount; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//构造函数根据给定的偏移量找到当前后台缓冲区的RTV</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mSwapChain-&gt;<span class="built_in">GetBuffer</span>(i, <span class="built_in">IID_PPV_ARGS</span>(&amp;mSwapChainBuffer[i])));</span><br><span class="line">		md3dDevice-&gt;<span class="built_in">CreateRenderTargetView</span>(mSwapChainBuffer[i].<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, rtvHeapHandle);<span class="comment">//堆中的首个句柄</span></span><br><span class="line">		rtvHeapHandle.<span class="built_in">Offset</span>(<span class="number">1</span>, mRtvDescriptorSize);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建深度/模板缓冲区和视口</span></span><br><span class="line">	D3D12_RESOURCE_DESC depthStencilDesc;</span><br><span class="line">	depthStencilDesc.Dimension= D3D12_RESOURCE_DIMENSION_TEXTURE2D;</span><br><span class="line">	depthStencilDesc.Alignment=<span class="number">0</span>;</span><br><span class="line">	depthStencilDesc.Width=mClientWidth;</span><br><span class="line">	depthStencilDesc.Height=mClientHeight;</span><br><span class="line">	depthStencilDesc.DepthOrArraySize=<span class="number">1</span>;</span><br><span class="line">	depthStencilDesc.MipLevels=<span class="number">1</span>;</span><br><span class="line">	depthStencilDesc.Format=mDepthStencilFormat;</span><br><span class="line">	depthStencilDesc.SampleDesc.Count=m4xMsaaState?<span class="number">4</span>:<span class="number">1</span>;</span><br><span class="line">	depthStencilDesc.SampleDesc.Quality=m4xMsaaState?(m4xMsaaQuality<span class="number">-1</span>):<span class="number">0</span>;</span><br><span class="line">	depthStencilDesc.Layout=D3D12_TEXTURE_LAYOUT_UNKNOWN;</span><br><span class="line">	depthStencilDesc.Flags=D3D12_RESOURCE_FLAG_ALLOW_DEPTH_STENCIL;</span><br><span class="line"></span><br><span class="line">	D3D12_CLEAR_VALUE optClear;</span><br><span class="line">	optClear.Format=mDepthStencilFormat;</span><br><span class="line">	optClear.DepthStencil.Depth=<span class="number">1.0f</span>;</span><br><span class="line">	optClear.DepthStencil.Stencil=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommittedResource</span>(</span><br><span class="line">		&amp;<span class="built_in">CD3DX12_HEAP_PROPERTIES</span>(D3D12_HEAP_TYPE_DEFAULT),</span><br><span class="line">		D3D12_HEAP_FLAG_NONE,</span><br><span class="line">		&amp;depthStencilDesc,</span><br><span class="line">		D3D12_RESOURCE_STATE_COMMON,</span><br><span class="line">		&amp;optClear,</span><br><span class="line">		<span class="built_in">IID_PPV_ARGS</span>(mDepthStencilBuffer.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//使用资源的格式将描述符创建为整个资源的MIP级别0。</span></span><br><span class="line">	md3dDevice-&gt;<span class="built_in">CreateDepthStencilView</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(),<span class="literal">nullptr</span>, <span class="built_in">DepthStencilView</span>());</span><br><span class="line">	<span class="comment">//将资源从其初始状态转换为深度缓冲区。</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">ResourceBarrier</span>(<span class="number">1</span>,&amp;CD3DX12_RESOURCE_BARRIER::<span class="built_in">Transition</span>(mDepthStencilBuffer.<span class="built_in">Get</span>(),D3D12_RESOURCE_STATE_COMMON,D3D12_RESOURCE_STATE_DEPTH_WRITE));</span><br><span class="line">	<span class="comment">//执行resize命令</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandList-&gt;<span class="built_in">Close</span>());</span><br><span class="line">	ID3D12CommandList* cmdsLists[]=&#123;mCommandList.<span class="built_in">Get</span>()&#125;;</span><br><span class="line">	mCommandQueue-&gt;<span class="built_in">ExecuteCommandLists</span>(_countof(cmdsLists),cmdsLists);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//等待到resize完成</span></span><br><span class="line">	<span class="built_in">FlushCommandQueue</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//更新视口变换以覆盖客户区域。</span></span><br><span class="line">	mScreenViewport.TopLeftX = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.TopLeftY = <span class="number">0</span>;</span><br><span class="line">	mScreenViewport.Width = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientWidth);</span><br><span class="line">	mScreenViewport.Height = <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientHeight);</span><br><span class="line">	mScreenViewport.MinDepth = <span class="number">0.0f</span>;</span><br><span class="line">	mScreenViewport.MaxDepth = <span class="number">1.0f</span>;</span><br><span class="line"></span><br><span class="line">	mScissorRect=&#123;<span class="number">0</span>,<span class="number">0</span>,mClientWidth,mClientHeight&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::Initialize</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">InitMainWindow</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">InitDirect3D</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">OnResize</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CreateRtvAndDsvDescriptorHeaps</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_DESC rtvHeapDesc;</span><br><span class="line">	rtvHeapDesc.NumDescriptors=SwapChainBufferCount;</span><br><span class="line">	rtvHeapDesc.Type=D3D12_DESCRIPTOR_HEAP_TYPE_RTV;</span><br><span class="line">	rtvHeapDesc.Flags=D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	rtvHeapDesc.NodeMask=<span class="number">0</span>;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;rtvHeapDesc,<span class="built_in">IID_PPV_ARGS</span>(mRtvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">	D3D12_DESCRIPTOR_HEAP_DESC dsvHeapDesc;</span><br><span class="line">	dsvHeapDesc.NumDescriptors = SwapChainBufferCount;</span><br><span class="line">	dsvHeapDesc.Type = D3D12_DESCRIPTOR_HEAP_TYPE_DSV;</span><br><span class="line">	dsvHeapDesc.Flags = D3D12_DESCRIPTOR_HEAP_FLAG_NONE;</span><br><span class="line">	dsvHeapDesc.NodeMask = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateDescriptorHeap</span>(&amp;dsvHeapDesc, <span class="built_in">IID_PPV_ARGS</span>(mDsvHeap.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::InitMainWindow</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	WNDCLASS wc;</span><br><span class="line">	wc.style = CS_HREDRAW | CS_VREDRAW;</span><br><span class="line">	wc.lpfnWndProc = MainWndProc;</span><br><span class="line">	wc.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">	wc.cbWndExtra = <span class="number">0</span>;</span><br><span class="line">	wc.hInstance = mhAppInst;</span><br><span class="line">	wc.hIcon = <span class="built_in">LoadIcon</span>(<span class="number">0</span>, IDI_APPLICATION);</span><br><span class="line">	wc.hCursor = <span class="built_in">LoadCursor</span>(<span class="number">0</span>, IDC_ARROW);</span><br><span class="line">	wc.hbrBackground = (HBRUSH)<span class="built_in">GetStockObject</span>(NULL_BRUSH);</span><br><span class="line">	wc.lpszMenuName = <span class="number">0</span>;</span><br><span class="line">	wc.lpszClassName = <span class="string">L&quot;MainWnd&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">RegisterClass</span>(&amp;wc))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBox</span>(<span class="number">0</span>, <span class="string">L&quot;RegisterClass Failed.&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compute window rectangle dimensions based on requested client area dimensions.</span></span><br><span class="line">	RECT R = &#123; <span class="number">0</span>, <span class="number">0</span>, mClientWidth, mClientHeight &#125;;</span><br><span class="line">	<span class="built_in">AdjustWindowRect</span>(&amp;R, WS_OVERLAPPEDWINDOW, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">int</span> width = R.right - R.left;</span><br><span class="line">	<span class="keyword">int</span> height = R.bottom - R.top;</span><br><span class="line"></span><br><span class="line">	mhMainWnd = <span class="built_in">CreateWindow</span>(<span class="string">L&quot;MainWnd&quot;</span>, mMainWndCaption.<span class="built_in">c_str</span>(),</span><br><span class="line">		WS_OVERLAPPEDWINDOW, CW_USEDEFAULT, CW_USEDEFAULT, width, height, <span class="number">0</span>, <span class="number">0</span>, mhAppInst, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (!mhMainWnd)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">MessageBox</span>(<span class="number">0</span>, <span class="string">L&quot;CreateWindow Failed.&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">ShowWindow</span>(mhMainWnd, SW_SHOW);</span><br><span class="line">	<span class="built_in">UpdateWindow</span>(mhMainWnd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::InitDirect3D</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//	&#123;</span></span><br><span class="line"><span class="comment">//#if defined(DEBUG) || defined(_DEBUG) </span></span><br><span class="line"><span class="comment">//		// Enable the D3D12 debug layer.</span></span><br><span class="line"><span class="comment">//		&#123;</span></span><br><span class="line"><span class="comment">//			ComPtr&lt;ID3D12Debug&gt; debugController;</span></span><br><span class="line"><span class="comment">//			ThrowIfFailed(D3D12GetDebugInterface(IID_PPV_ARGS(&amp;debugController)));</span></span><br><span class="line"><span class="comment">//			debugController-&gt;EnableDebugLayer();</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line"><span class="comment">//#endif</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(<span class="built_in">CreateDXGIFactory</span>(<span class="built_in">IID_PPV_ARGS</span>(&amp;mdxgiFactory)));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//创建硬件设备</span></span><br><span class="line">	HRESULT hardwareResult = <span class="built_in">D3D12CreateDevice</span>(<span class="literal">nullptr</span>, D3D_FEATURE_LEVEL_11_0, <span class="built_in">IID_PPV_ARGS</span>(&amp;md3dDevice));<span class="comment">//第一个参数是空则使用默认显示器</span></span><br><span class="line">	<span class="comment">//回退至WARP设备</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">FAILED</span>(hardwareResult))</span><br><span class="line">	&#123;</span><br><span class="line">		ComPtr&lt;IDXGIAdapter&gt; pWarpAdapter;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mdxgiFactory-&gt;<span class="built_in">EnumWarpAdapter</span>(<span class="built_in">IID_PPV_ARGS</span>(&amp;pWarpAdapter)));</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(<span class="built_in">D3D12CreateDevice</span>(pWarpAdapter.<span class="built_in">Get</span>(), D3D_FEATURE_LEVEL_11_0, <span class="built_in">IID_PPV_ARGS</span>(&amp;md3dDevice)));</span><br><span class="line">	&#125;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateFence</span>(<span class="number">0</span>, D3D12_FENCE_FLAG_NONE, <span class="built_in">IID_PPV_ARGS</span>(&amp;mFence)));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//描述符信息，方便以后使用</span></span><br><span class="line">		mRtvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_RTV);</span><br><span class="line">		mDsvDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_DSV);</span><br><span class="line">		mCbvSrvUavDescriptorSize = md3dDevice-&gt;<span class="built_in">GetDescriptorHandleIncrementSize</span>(D3D12_DESCRIPTOR_HEAP_TYPE_CBV_SRV_UAV);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//检查4X MSAA质量对我们的后缓冲区格式的支持。</span></span><br><span class="line">		 <span class="comment">//所有支持Direct3D 11的设备都对所有渲染支持4倍MSAA</span></span><br><span class="line">		 <span class="comment">//目标格式，因此我们只需要检查质量支持。</span></span><br><span class="line">		D3D12_FEATURE_DATA_MULTISAMPLE_QUALITY_LEVELS msQualityLevels;</span><br><span class="line">		msQualityLevels.Format = mBackBufferFormat;</span><br><span class="line">		msQualityLevels.SampleCount = <span class="number">4</span>;</span><br><span class="line">		msQualityLevels.Flags = D3D12_MULTISAMPLE_QUALITY_LEVELS_FLAG_NONE;</span><br><span class="line">		msQualityLevels.NumQualityLevels = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CheckFeatureSupport</span>(D3D12_FEATURE_MULTISAMPLE_QUALITY_LEVELS, &amp;msQualityLevels, <span class="built_in"><span class="keyword">sizeof</span></span>(msQualityLevels)));</span><br><span class="line">		m4xMsaaQuality = msQualityLevels.NumQualityLevels;</span><br><span class="line">		<span class="built_in">assert</span>(m4xMsaaQuality &gt; <span class="number">0</span> &amp;&amp; <span class="string">&quot;Unexpected MSAA quality level.&quot;</span>);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">		<span class="built_in">CreateCommandObjects</span>();</span><br><span class="line">		<span class="built_in">CreateSwapChain</span>();</span><br><span class="line">		<span class="built_in">CreateRtvAndDsvDescriptorHeaps</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::FlushCommandQueue</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//提升围栏值以将命令标记到该围栏点。</span></span><br><span class="line">	mCurrentFence++;</span><br><span class="line">	<span class="comment">//将指令添加到命令队列以设置新的防护点。 因为我们</span></span><br><span class="line">	<span class="comment">//在GPU时间轴上，直到GPU完成后才会设置新的围栏点</span></span><br><span class="line">	<span class="comment">//处理此Signal（）之前的所有命令。</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mCommandQueue-&gt;<span class="built_in">Signal</span>(mFence.<span class="built_in">Get</span>(),mCurrentFence));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//等待直到GPU完成命令为止。</span></span><br><span class="line">	<span class="keyword">if</span> (mFence-&gt;<span class="built_in">GetCompletedValue</span>() &lt; mCurrentFence)</span><br><span class="line">	&#123;</span><br><span class="line">		HANDLE eventHandle=<span class="built_in">CreateEventEx</span>(<span class="literal">nullptr</span>,<span class="literal">false</span>,<span class="literal">false</span>,EVENT_ALL_ACCESS);</span><br><span class="line">		<span class="comment">//GPU击中当前围墙时触发事件。</span></span><br><span class="line">		<span class="built_in">ThrowIfFailed</span>(mFence-&gt;<span class="built_in">SetEventOnCompletion</span>(mCurrentFence,eventHandle));</span><br><span class="line"></span><br><span class="line">		<span class="comment">//等到GPU击中当前的fence事件后再触发。</span></span><br><span class="line">		<span class="built_in">WaitForSingleObject</span>(eventHandle,INFINITE);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(eventHandle);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CreateSwapChain</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	mSwapChain.<span class="built_in">Reset</span>();</span><br><span class="line">	DXGI_SWAP_CHAIN_DESC sd;</span><br><span class="line">	sd.BufferDesc.Width = mClientWidth;</span><br><span class="line">	sd.BufferDesc.Height = mClientHeight;</span><br><span class="line">	sd.BufferDesc.RefreshRate.Numerator = <span class="number">60</span>;</span><br><span class="line">	sd.BufferDesc.RefreshRate.Denominator = <span class="number">1</span>;</span><br><span class="line">	sd.BufferDesc.Format = mBackBufferFormat;</span><br><span class="line">	sd.BufferDesc.ScanlineOrdering = DXGI_MODE_SCANLINE_ORDER_UNSPECIFIED;</span><br><span class="line">	sd.BufferDesc.Scaling = DXGI_MODE_SCALING_UNSPECIFIED;</span><br><span class="line">	sd.SampleDesc.Count = m4xMsaaState ? <span class="number">4</span> : <span class="number">1</span>;</span><br><span class="line">	sd.SampleDesc.Quality = m4xMsaaState ? (m4xMsaaQuality - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">	sd.BufferUsage = DXGI_USAGE_RENDER_TARGET_OUTPUT;</span><br><span class="line">	sd.BufferCount = SwapChainBufferCount;</span><br><span class="line">	sd.OutputWindow = mhMainWnd;</span><br><span class="line">	sd.Windowed = <span class="literal">true</span>;</span><br><span class="line">	sd.SwapEffect = DXGI_SWAP_EFFECT_FLIP_DISCARD;</span><br><span class="line">	sd.Flags = DXGI_SWAP_CHAIN_FLAG_ALLOW_MODE_SWITCH;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Note: Swap chain uses queue to perform flush.</span></span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(mdxgiFactory-&gt;<span class="built_in">CreateSwapChain</span>(</span><br><span class="line">		mCommandQueue.<span class="built_in">Get</span>(),</span><br><span class="line">		&amp;sd,</span><br><span class="line">		mSwapChain.<span class="built_in">GetAddressOf</span>()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CreateCommandObjects</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	D3D12_COMMAND_QUEUE_DESC queueDesc = &#123;&#125;;</span><br><span class="line">	queueDesc.Type = D3D12_COMMAND_LIST_TYPE_DIRECT;</span><br><span class="line">	queueDesc.Flags = D3D12_COMMAND_QUEUE_FLAG_NONE;</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandQueue</span>(&amp;queueDesc, <span class="built_in">IID_PPV_ARGS</span>(&amp;mCommandQueue)));</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandAllocator</span>(D3D12_COMMAND_LIST_TYPE_DIRECT, <span class="built_in">IID_PPV_ARGS</span>(mDirectCmdListAlloc.<span class="built_in">GetAddressOf</span>())));</span><br><span class="line">	<span class="built_in">ThrowIfFailed</span>(md3dDevice-&gt;<span class="built_in">CreateCommandList</span>(<span class="number">0</span>, D3D12_COMMAND_LIST_TYPE_DIRECT, mDirectCmdListAlloc.<span class="built_in">Get</span>(), <span class="literal">nullptr</span>, <span class="built_in">IID_PPV_ARGS</span>(mCommandList.<span class="built_in">ReleaseAndGetAddressOf</span>())));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//从关闭状态开始。 这是因为我们第一次提到</span></span><br><span class="line">	<span class="comment">//在命令列表中，我们将对其进行重置，并且需要先关闭它</span></span><br><span class="line">	<span class="comment">//调用Reset。</span></span><br><span class="line">	mCommandList-&gt;<span class="built_in">Close</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ID3D12Resource* <span class="title">DXApp::CurrentBackBuffer</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mSwapChainBuffer[mCurrBackBuffer].<span class="built_in">Get</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">DXApp::CurrentBackBufferView</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">CD3DX12_CPU_DESCRIPTOR_HANDLE</span>(</span><br><span class="line">		mRtvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>(),</span><br><span class="line">		mCurrBackBuffer,</span><br><span class="line">		mRtvDescriptorSize);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">D3D12_CPU_DESCRIPTOR_HANDLE <span class="title">DXApp::DepthStencilView</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mDsvHeap-&gt;<span class="built_in">GetCPUDescriptorHandleForHeapStart</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::LogAdapters</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT i = <span class="number">0</span>;</span><br><span class="line">	IDXGIAdapter* adapter = <span class="literal">nullptr</span>;</span><br><span class="line">	std::vector&lt;IDXGIAdapter*&gt; adapterList;</span><br><span class="line">	<span class="keyword">while</span> (mdxgiFactory-&gt;<span class="built_in">EnumAdapters</span>(i, &amp;adapter) != DXGI_ERROR_NOT_FOUND)</span><br><span class="line">	&#123;</span><br><span class="line">		DXGI_ADAPTER_DESC desc;</span><br><span class="line">		adapter-&gt;<span class="built_in">GetDesc</span>(&amp;desc);</span><br><span class="line"></span><br><span class="line">		std::wstring text = <span class="string">L&quot;***Adapter: &quot;</span>;</span><br><span class="line">		text += desc.Description;</span><br><span class="line">		text += <span class="string">L&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">OutputDebugString</span>(text.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">		adapterList.<span class="built_in">push_back</span>(adapter);</span><br><span class="line"></span><br><span class="line">		++i;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; adapterList.<span class="built_in">size</span>(); ++i)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">LogAdapterOutputs</span>(adapterList[i]);</span><br><span class="line">		<span class="built_in">ReleaseCom</span>(adapterList[i]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::LogAdapterOutputs</span><span class="params">(IDXGIAdapter* adapter)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT i = <span class="number">0</span>;</span><br><span class="line">	IDXGIOutput* output = <span class="literal">nullptr</span>;</span><br><span class="line">	<span class="keyword">while</span> (adapter-&gt;<span class="built_in">EnumOutputs</span>(i, &amp;output) != DXGI_ERROR_NOT_FOUND)</span><br><span class="line">	&#123;</span><br><span class="line">		DXGI_OUTPUT_DESC desc;</span><br><span class="line">		output-&gt;<span class="built_in">GetDesc</span>(&amp;desc);</span><br><span class="line"></span><br><span class="line">		std::wstring text = <span class="string">L&quot;***Output: &quot;</span>;</span><br><span class="line">		text += desc.DeviceName;</span><br><span class="line">		text += <span class="string">L&quot;\n&quot;</span>;</span><br><span class="line">		<span class="built_in">OutputDebugString</span>(text.<span class="built_in">c_str</span>());</span><br><span class="line"></span><br><span class="line">		<span class="built_in">LogOutputDisplayModes</span>(output, mBackBufferFormat);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">ReleaseCom</span>(output);</span><br><span class="line"></span><br><span class="line">		++i;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::LogOutputDisplayModes</span><span class="params">(IDXGIOutput* output, DXGI_FORMAT format)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	UINT count = <span class="number">0</span>;</span><br><span class="line">	UINT flags = <span class="number">0</span>; </span><br><span class="line"></span><br><span class="line">	<span class="comment">// Call with nullptr to get list count.</span></span><br><span class="line">	output-&gt;<span class="built_in">GetDisplayModeList</span>(format, flags, &amp;count, <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">	<span class="function">std::vector&lt;DXGI_MODE_DESC&gt; <span class="title">modeList</span><span class="params">(count)</span></span>;</span><br><span class="line">	output-&gt;<span class="built_in">GetDisplayModeList</span>(format, flags, &amp;count, &amp;modeList[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; x : modeList)</span><br><span class="line">	&#123;</span><br><span class="line">		UINT n = x.RefreshRate.Numerator;</span><br><span class="line">		UINT d = x.RefreshRate.Denominator;</span><br><span class="line">		std::wstring text =</span><br><span class="line">			<span class="string">L&quot;Width = &quot;</span> + std::<span class="built_in">to_wstring</span>(x.Width) + <span class="string">L&quot; &quot;</span> +</span><br><span class="line">			<span class="string">L&quot;Height = &quot;</span> + std::<span class="built_in">to_wstring</span>(x.Height) + <span class="string">L&quot; &quot;</span> +</span><br><span class="line">			<span class="string">L&quot;Refresh = &quot;</span> + std::<span class="built_in">to_wstring</span>(n) + <span class="string">L&quot;/&quot;</span> + std::<span class="built_in">to_wstring</span>(d) +</span><br><span class="line">			<span class="string">L&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">		::<span class="built_in">OutputDebugString</span>(text.<span class="built_in">c_str</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">DXApp* <span class="title">DXApp::GetApp</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mApp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HINSTANCE <span class="title">DXApp::AppInst</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mhAppInst;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">HWND <span class="title">DXApp::MainWnd</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> mhMainWnd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">DXApp::AspectRatio</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">static_cast</span>&lt;<span class="keyword">float</span>&gt;(mClientWidth) / mClientHeight;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">DXApp::Get4xMsaaState</span><span class="params">()</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> m4xMsaaState;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::Set4xMsaaState</span><span class="params">(<span class="keyword">bool</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (m4xMsaaState!=value)</span><br><span class="line">	&#123;</span><br><span class="line">		m4xMsaaState = value;</span><br><span class="line">		<span class="comment">//重置4xmasaa需要重新创建交换链和刷新尺寸</span></span><br><span class="line">		<span class="built_in">CreateSwapChain</span>();</span><br><span class="line">		<span class="built_in">OnResize</span>();</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">DXApp::Run</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	MSG msg = &#123; <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	mTimer.<span class="built_in">Reset</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (msg.message != WM_QUIT)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// If there are Window messages then process them.</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">PeekMessage</span>(&amp;msg, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, PM_REMOVE))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">TranslateMessage</span>(&amp;msg);</span><br><span class="line">			<span class="built_in">DispatchMessage</span>(&amp;msg);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Otherwise, do animation/game stuff.</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			mTimer.<span class="built_in">Tick</span>();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (!mAppPaused)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">CalculateFrameStats</span>();</span><br><span class="line">				<span class="built_in">Update</span>(mTimer);</span><br><span class="line">				<span class="built_in">Draw</span>(mTimer);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="built_in">Sleep</span>(<span class="number">100</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">int</span>)msg.wParam;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DXApp::CalculateFrameStats</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// Code computes the average frames per second, and also the </span></span><br><span class="line">		<span class="comment">// average time it takes to render one frame.  These stats </span></span><br><span class="line">		<span class="comment">// are appended to the window caption bar.</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> frameCnt = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">float</span> timeElapsed = <span class="number">0.0f</span>;</span><br><span class="line"></span><br><span class="line">	frameCnt++;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Compute averages over one second period.</span></span><br><span class="line">	<span class="keyword">if</span> ((mTimer.<span class="built_in">TotalTime</span>() - timeElapsed) &gt;= <span class="number">1.0f</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">float</span> fps = (<span class="keyword">float</span>)frameCnt; <span class="comment">// fps = frameCnt / 1</span></span><br><span class="line">		<span class="keyword">float</span> mspf = <span class="number">1000.0f</span> / fps;</span><br><span class="line"></span><br><span class="line">		wstring fpsStr = <span class="built_in">to_wstring</span>(fps);</span><br><span class="line">		wstring mspfStr = <span class="built_in">to_wstring</span>(mspf);</span><br><span class="line"></span><br><span class="line">		wstring windowText = mMainWndCaption +</span><br><span class="line">			<span class="string">L&quot;    fps: &quot;</span> + fpsStr +</span><br><span class="line">			<span class="string">L&quot;   mspf: &quot;</span> + mspfStr;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">SetWindowText</span>(mhMainWnd, <span class="string">L&quot;window text&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Reset for next average.</span></span><br><span class="line">		frameCnt = <span class="number">0</span>;</span><br><span class="line">		timeElapsed += <span class="number">1.0f</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LRESULT <span class="title">DXApp::MsgProc</span><span class="params">(HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in"><span class="keyword">switch</span></span> (msg)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">//激活或停用窗口时发送WM_ACTIVATE。</span></span><br><span class="line">		<span class="comment">//当停用窗口时我们暂停游戏</span></span><br><span class="line">		<span class="comment">//当它变为活动状态时取消暂停</span></span><br><span class="line">	<span class="keyword">case</span> WM_ACTIVATE:</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">LOWORD</span>(wParam)==WA_INACTIVE)</span><br><span class="line">		&#123;</span><br><span class="line">			mAppPaused = <span class="literal">true</span>;</span><br><span class="line">			mTimer.<span class="built_in">Stop</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			mAppPaused = <span class="literal">false</span>;</span><br><span class="line">			mTimer.<span class="built_in">Start</span>();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 当用户调整窗口大小时，发送WM_SIZE。</span></span><br><span class="line">	<span class="keyword">case</span> WM_SIZE:</span><br><span class="line">		<span class="comment">// 保存新的客户区域尺寸。</span></span><br><span class="line">		mClientWidth = <span class="built_in">LOWORD</span>(lParam);</span><br><span class="line">		mClientHeight = <span class="built_in">HIWORD</span>(lParam);</span><br><span class="line">		<span class="keyword">if</span> (md3dDevice)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (wParam == SIZE_MINIMIZED)</span><br><span class="line">			&#123;</span><br><span class="line">				mAppPaused = <span class="literal">true</span>;</span><br><span class="line">				mMinimized = <span class="literal">true</span>;</span><br><span class="line">				mMaximized = <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (wParam == SIZE_MAXIMIZED)</span><br><span class="line">			&#123;</span><br><span class="line">				mAppPaused = <span class="literal">false</span>;</span><br><span class="line">				mMinimized = <span class="literal">false</span>;</span><br><span class="line">				mMaximized = <span class="literal">true</span>;</span><br><span class="line">				<span class="built_in">OnResize</span>();</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (wParam == SIZE_RESTORED)</span><br><span class="line">			&#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Restoring from minimized state?</span></span><br><span class="line">				<span class="keyword">if</span> (mMinimized)</span><br><span class="line">				&#123;</span><br><span class="line">					mAppPaused = <span class="literal">false</span>;</span><br><span class="line">					mMinimized = <span class="literal">false</span>;</span><br><span class="line">					<span class="built_in">OnResize</span>();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Restoring from maximized state?</span></span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (mMaximized)</span><br><span class="line">				&#123;</span><br><span class="line">					mAppPaused = <span class="literal">false</span>;</span><br><span class="line">					mMaximized = <span class="literal">false</span>;</span><br><span class="line">					<span class="built_in">OnResize</span>();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span> (mResizing)</span><br><span class="line">				&#123;</span><br><span class="line">				<span class="comment">//如果用户拖动调整大小栏，我们不会调整大小</span></span><br><span class="line">				<span class="comment">//这里的缓冲区，因为随着用户的不断前进</span></span><br><span class="line">				<span class="comment">//拖动调整大小条，WM_SIZE消息流是</span></span><br><span class="line">				<span class="comment">//发送到窗口，它将毫无意义（而且很慢）</span></span><br><span class="line">				<span class="comment">//为从拖动中收到的每个WM_SIZE消息调整大小</span></span><br><span class="line">				<span class="comment">//调整尺寸栏。 因此，我们在用户</span></span><br><span class="line">				<span class="comment">//完成调整窗口大小并释放大小调整条</span></span><br><span class="line">				<span class="comment">//发送WM_EXITSIZEMOVE消息。</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="comment">// API call such as SetWindowPos or mSwapChain-&gt;SetFullscreenState.</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="built_in">OnResize</span>();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 当用户抓住调整大小条时，将发送WM_EXITSIZEMOVE。</span></span><br><span class="line">	<span class="keyword">case</span> WM_ENTERSIZEMOVE:</span><br><span class="line">		mAppPaused = <span class="literal">true</span>;</span><br><span class="line">		mResizing = <span class="literal">true</span>;</span><br><span class="line">		mTimer.<span class="built_in">Stop</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//当用户释放大小调整条时，发送WM_EXITSIZEMOVE。</span></span><br><span class="line">		<span class="comment">//在这里，我们根据新窗口的尺寸重置所有内容。</span></span><br><span class="line">	<span class="keyword">case</span> WM_EXITSIZEMOVE:</span><br><span class="line">		mAppPaused = <span class="literal">false</span>;</span><br><span class="line">		mResizing = <span class="literal">false</span>;</span><br><span class="line">		mTimer.<span class="built_in">Start</span>();</span><br><span class="line">		<span class="built_in">OnResize</span>();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">//销毁窗口时发送WM_DESTROY。</span></span><br><span class="line">	<span class="keyword">case</span> WM_DESTROY:</span><br><span class="line">		<span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// 当菜单处于活动状态并且用户按下时，将发送WM_MENUCHAR消息与任何助记键或加速键都不对应的键。</span></span><br><span class="line">	<span class="keyword">case</span> WM_MENUCHAR:</span><br><span class="line">		<span class="comment">// 进入时不要发出哔声。</span></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">MAKELRESULT</span>(<span class="number">0</span>, MNC_CLOSE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">//捕获此消息，以防止窗口变得太小。</span></span><br><span class="line">	<span class="keyword">case</span> WM_GETMINMAXINFO:</span><br><span class="line">		((MINMAXINFO*)lParam)-&gt;ptMinTrackSize.x = <span class="number">200</span>;</span><br><span class="line">		((MINMAXINFO*)lParam)-&gt;ptMinTrackSize.y = <span class="number">200</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> WM_LBUTTONDOWN:</span><br><span class="line">	<span class="keyword">case</span> WM_MBUTTONDOWN:</span><br><span class="line">	<span class="keyword">case</span> WM_RBUTTONDOWN:</span><br><span class="line">		<span class="built_in">OnMouseDown</span>(wParam, <span class="built_in">GET_X_LPARAM</span>(lParam), <span class="built_in">GET_Y_LPARAM</span>(lParam));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> WM_LBUTTONUP:</span><br><span class="line">	<span class="keyword">case</span> WM_MBUTTONUP:</span><br><span class="line">	<span class="keyword">case</span> WM_RBUTTONUP:</span><br><span class="line">		<span class="built_in">OnMouseUp</span>(wParam, <span class="built_in">GET_X_LPARAM</span>(lParam), <span class="built_in">GET_Y_LPARAM</span>(lParam));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> WM_MOUSEMOVE:</span><br><span class="line">		<span class="built_in">OnMouseMove</span>(wParam, <span class="built_in">GET_X_LPARAM</span>(lParam), <span class="built_in">GET_Y_LPARAM</span>(lParam));</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">case</span> WM_KEYUP:</span><br><span class="line">		<span class="keyword">if</span> (wParam == VK_ESCAPE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">PostQuitMessage</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">int</span>)wParam == VK_F2)</span><br><span class="line">			<span class="built_in">Set4xMsaaState</span>(!m4xMsaaState);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">DefWindowProc</span>(hwnd, msg, wParam, lParam);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/" class="post-title-link" itemprop="url">《Fightting Game Template》Documentation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-15 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-15T00:00:00+08:00">2020-06-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:13:15" itemprop="dateModified" datetime="2021-08-02T16:13:15+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/15/%E8%B6%855%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/" class="cy_cmt_count" data-xid="2020/06/15/超5说明文档EN/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>715</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Instructions"><a href="#Instructions" class="headerlink" title="Instructions"></a>Instructions</h2><ul>
<li>It is very important that you should click the <strong>option button</strong> to set your keys ，and save it</li>
<li>Click the Multiplayer button to enter the character selection interface<ul>
<li>V1.0 has no AI so we can not click <code>SinglePlayer</code> button</li>
</ul>
</li>
<li>Use the <code>LEFT</code> and <code>RIGHT</code> buttons and <code>A</code> button in your button settings to select and confirm the role<ul>
<li>ps. <code>A</code> Key is not the keyboard <code>A</code>， but the <code>A</code> in the game, generally the default is <code>U</code> key</li>
</ul>
</li>
<li>Then player 1 can use the same operation to select the map</li>
<li>After that，let’s battle！</li>
</ul>
<h2 id="Charcater-Moves"><a href="#Charcater-Moves" class="headerlink" title="Charcater Moves"></a>Charcater Moves</h2><h3 id="WuKong"><a href="#WuKong" class="headerlink" title="WuKong"></a>WuKong</h3><h5 id="NormalMoves"><a href="#NormalMoves" class="headerlink" title="NormalMoves"></a>NormalMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>2</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+B/D</td>
<td>3</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>4</td>
</tr>
</tbody></table>
<h5 id="SpecialMoves"><a href="#SpecialMoves" class="headerlink" title="SpecialMoves"></a>SpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+A/C</td>
<td>2</td>
</tr>
</tbody></table>
<h5 id="MaxSpecialMoves"><a href="#MaxSpecialMoves" class="headerlink" title="MaxSpecialMoves"></a>MaxSpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td>(<strong>In Max Stat</strong>)<img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
</tbody></table>
<h3 id="Aurora"><a href="#Aurora" class="headerlink" title="Aurora"></a>Aurora</h3><h5 id="NormalMoves-1"><a href="#NormalMoves-1" class="headerlink" title="NormalMoves"></a>NormalMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+A/C</td>
<td>2</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+B/D</td>
<td>3</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+B/D</td>
<td>4</td>
</tr>
</tbody></table>
<h5 id="SpecialMoves-1"><a href="#SpecialMoves-1" class="headerlink" title="SpecialMoves"></a>SpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
<tr>
<td><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_L.png" style="zoom:10%;" />+B/D</td>
<td>2</td>
</tr>
</tbody></table>
<h5 id="MaxSpecialMoves-1"><a href="#MaxSpecialMoves-1" class="headerlink" title="MaxSpecialMoves"></a>MaxSpecialMoves</h5><table>
<thead>
<tr>
<th>Keys</th>
<th>Moves(temp name)</th>
</tr>
</thead>
<tbody><tr>
<td>(<strong>In Max Stat</strong>)<img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_D.png" style="zoom:10%;" /><img src="https://img.supervj.top/img/FighttingGamearrow_r.png" style="zoom:10%;" />+A/C</td>
<td>1</td>
</tr>
</tbody></table>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/" class="post-title-link" itemprop="url">路径点优化</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-12 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-12T00:00:00+08:00">2020-06-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:36:06" itemprop="dateModified" datetime="2021-08-02T16:36:06+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/math/" itemprop="url" rel="index"><span itemprop="name">math</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/" class="cy_cmt_count" data-xid="2020/06/12/路径优化/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文介绍路径点的优化方式，或者叫做多线段优化、轨迹点优化</p>
<p>根据设定阈值，去掉路径点中的部分多余点，以达到方便传输的目的</p>
<p>本文用UE4蓝图和C++蓝图函数库的2个方式解释</p>
<p><strong>注:多种方法可以叠加使用</strong></p>
</blockquote>
<p>本算法提供了基于UE4的Demo，<a target="_blank" rel="noopener" href="https://xshniteducn-my.sharepoint.com/:u:/g/personal/15040920722_xs_hnit_edu_cn/EdZ7WHvq8mdHm2b0xRcJtWsBnhqVdqBx07E_Tr_s7mshDQ?e=8lhWkm">PC</a>，<a target="_blank" rel="noopener" href="https://xshniteducn-my.sharepoint.com/:u:/g/personal/15040920722_xs_hnit_edu_cn/ET-Wm3V8br1PuSrS0qUnwekBLP5bGpnZqZ8cGb3tGSLK-w?e=Y7wQmT">安卓</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/VJien/PathOptimazation">GitHub工程下载</a></p>
<p>Demo演示动图</p>
<p><img src="https://img.supervj.top/img/PathOptimization/pathOpt_10.gif"></p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/06/12/%E8%B7%AF%E5%BE%84%E4%BC%98%E5%8C%96/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">由SetActorLocation分析渲染流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-04 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-04T00:00:00+08:00">2020-06-04</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:20:26" itemprop="dateModified" datetime="2021-08-02T16:20:26+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/engine/" itemprop="url" rel="index"><span itemprop="name">engine</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/04/%E7%94%B1SetActorLocation%E5%88%86%E6%9E%90%E6%B8%B2%E6%9F%93%E6%B5%81%E7%A8%8B/" class="cy_cmt_count" data-xid="2020/06/04/由SetActorLocation分析渲染流程/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>角色位移本质上就是渲染问题，从这条思路我们去看看角色怎么实现这一部分渲染的</p>
</blockquote>
<h5 id="起点：SetActorLocation"><a href="#起点：SetActorLocation" class="headerlink" title="起点：SetActorLocation"></a>起点：SetActorLocation</h5><blockquote>
<p>蓝图调用的API实际调用的是K2_SetActorLocation，然后调用到此函数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> RootComponent-&gt;<span class="built_in">MoveComponent</span>(Delta, <span class="built_in">GetActorQuat</span>(), bSweep, OutSweepHitResult, MOVECOMP_NoFlags, Teleport);</span><br></pre></td></tr></table></figure>

<p>只看这个关键代码，调用<code>RootComponent</code>的<code>MoveComponent</code></p>
<h5 id="USceneComponent"><a href="#USceneComponent" class="headerlink" title="USceneComponent"></a>USceneComponent</h5><h6 id="MoveComponent"><a href="#MoveComponent" class="headerlink" title="MoveComponent"></a>MoveComponent</h6><blockquote>
<p>外部调用此函数后里面直接调用到带<code>Impl</code>后缀的虚函数</p>
<p>这个函数在UPrimitiveComponent内有重写</p>
</blockquote>
<p><code>USceneComponent</code>内主要调用了函数<code>ConditionalUpdateComponentToWorld</code>,而<code>UPrimitiveComponent</code>因为有碰撞等属性所以又多了很多逻辑，这里不多描述</p>
<h6 id="UpdateComponentToWorldWithParent"><a href="#UpdateComponentToWorldWithParent" class="headerlink" title="UpdateComponentToWorldWithParent"></a>UpdateComponentToWorldWithParent</h6><blockquote>
<p>此函数通过<code>ConditionalUpdateComponentToWorld</code>调用，后又调用到虚函数<code>UpdateComponentToWorld</code>,此虚函数在<code>UActorComponent</code>声明，在<code>USceneComponent</code>重写</p>
<p>然后再直接调用到此函数</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Parent &amp;&amp; !Parent-&gt;bComponentToWorldUpdated)</span><br><span class="line">&#123;</span><br><span class="line">	Parent-&gt;<span class="built_in">UpdateComponentToWorld</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (bComponentToWorldUpdated)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果有父级组件，先去处理他</p>
<p>然后调用到函数<code>PropagateTransformUpdate</code></p>
<h6 id="PropagateTransformUpdate"><a href="#PropagateTransformUpdate" class="headerlink" title="PropagateTransformUpdate"></a>PropagateTransformUpdate</h6><p>该函数执行了</p>
<ul>
<li>更新体积(Bounds)</li>
<li>更新变换(Transform)<ul>
<li>更新Attach的子组件的变换信息</li>
</ul>
</li>
<li>更新寻路信息</li>
</ul>
<p>其中有个关键的函数<code>UActorComponent::MarkRenderTransformDirty</code></p>
<p>然后经过简单判断以后调用<code>UActorComponent::MarkForNeededEndOfFrameUpdate</code></p>
<p>然后调用了<code>UWorld</code> 的<code>MarkActorComponentForNeededEndOfFrameUpdate</code></p>
<p>看主要代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UActorComponent::MarkRenderTransformDirty</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">IsRegistered</span>() &amp;&amp; bRenderStateCreated)</span><br><span class="line">	&#123;</span><br><span class="line">		bRenderTransformDirty = <span class="literal">true</span>;</span><br><span class="line">		<span class="built_in">MarkForNeededEndOfFrameUpdate</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UActorComponent::MarkForNeededEndOfFrameUpdate</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (bNeverNeedsRenderUpdate)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	UWorld* ComponentWorld = <span class="built_in">GetWorld</span>();</span><br><span class="line">	<span class="keyword">if</span> (ComponentWorld)</span><br><span class="line">	&#123;</span><br><span class="line">		ComponentWorld-&gt;<span class="built_in">MarkActorComponentForNeededEndOfFrameUpdate</span>(<span class="keyword">this</span>, <span class="built_in">RequiresGameThreadEndOfFrameUpdates</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">IsUnreachable</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// 如果没有世界，执行如下代码</span></span><br><span class="line">		<span class="built_in">DoDeferredRenderUpdates_Concurrent</span>();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UWorld"><a href="#UWorld" class="headerlink" title="UWorld"></a>UWorld</h5><h6 id="MarkActorComponentForNeededEndOfFrameUpdate"><a href="#MarkActorComponentForNeededEndOfFrameUpdate" class="headerlink" title="MarkActorComponentForNeededEndOfFrameUpdate"></a>MarkActorComponentForNeededEndOfFrameUpdate</h6><blockquote>
<p>代码在LevelTick.cpp L883</p>
</blockquote>
<p>主要执行了把组件添加到了等待渲染的列表<code>ComponentsThatNeedEndOfFrameUpdate_OnGameThread</code>里,当然还有一个非游戏线程的<code>ComponentsThatNeedEndOfFrameUpdate</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (bForceGameThread)</span><br><span class="line">		&#123;</span><br><span class="line">			FMarkComponentEndOfFrameUpdateState::<span class="built_in">Set</span>(Component, ComponentsThatNeedEndOfFrameUpdate_OnGameThread.<span class="built_in">Num</span>(), EComponentMarkedForEndOfFrameUpdateState::MarkedForGameThread);</span><br><span class="line">			ComponentsThatNeedEndOfFrameUpdate_OnGameThread.<span class="built_in">Add</span>(Component);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			FMarkComponentEndOfFrameUpdateState::<span class="built_in">Set</span>(Component, ComponentsThatNeedEndOfFrameUpdate.<span class="built_in">Num</span>(), EComponentMarkedForEndOfFrameUpdateState::Marked);</span><br><span class="line">			ComponentsThatNeedEndOfFrameUpdate.<span class="built_in">Add</span>(Component);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>到此我们大概知道了这一条线的终点了，然后去看看哪里使用到了这个数组</p>
<h6 id="SendAllEndOfFrameUpdates"><a href="#SendAllEndOfFrameUpdates" class="headerlink" title="SendAllEndOfFrameUpdates"></a>SendAllEndOfFrameUpdates</h6><p>确认使用上面数组是在此函数内，查找引用发现此函数在很多地方被调用，如<code>SceneRendering.cpp</code>,<code>UnrealEngine.cpp</code>大概就是要更新场景最新的渲染的时候就会调用，先不理会，看这个函数内实现</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (UActorComponent* Component : ComponentsThatNeedEndOfFrameUpdate_OnGameThread)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span> (Component)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span> (Component-&gt;<span class="built_in">IsRegistered</span>() &amp;&amp; !Component-&gt;<span class="built_in">IsTemplate</span>() &amp;&amp; !Component-&gt;<span class="built_in">IsPendingKill</span>())</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="function">FScopeCycleCounterUObject <span class="title">ComponentScope</span><span class="params">(Component)</span></span>;</span><br><span class="line">					<span class="function">FScopeCycleCounterUObject <span class="title">AdditionalScope</span><span class="params">(STATS ? Component-&gt;AdditionalStatObject() : <span class="literal">nullptr</span>)</span></span>;</span><br><span class="line">					Component-&gt;<span class="built_in">DoDeferredRenderUpdates_Concurrent</span>();</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="built_in">check</span>(Component-&gt;<span class="built_in">IsPendingKill</span>() || Component-&gt;<span class="built_in">GetMarkedForEndOfFrameUpdateState</span>() == EComponentMarkedForEndOfFrameUpdateState::MarkedForGameThread);</span><br><span class="line">				FMarkComponentEndOfFrameUpdateState::<span class="built_in">Set</span>(Component, INDEX_NONE, EComponentMarkedForEndOfFrameUpdateState::Unmarked);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ComponentsThatNeedEndOfFrameUpdate_OnGameThread.<span class="built_in">Reset</span>();</span><br><span class="line">		ComponentsThatNeedEndOfFrameUpdate.<span class="built_in">Reset</span>();</span><br></pre></td></tr></table></figure>

<p>遍历了所有数组成员，主要执行了<code>DoDeferredRenderUpdates_Concurrent</code>，回头看<code>USceneComponent</code>内的如果没有<code>UWorld</code>就直接调用了这个函数</p>
<h5 id="UActorComponent"><a href="#UActorComponent" class="headerlink" title="UActorComponent"></a>UActorComponent</h5><h6 id="DoDeferredRenderUpdates-Concurrent"><a href="#DoDeferredRenderUpdates-Concurrent" class="headerlink" title="DoDeferredRenderUpdates_Concurrent"></a>DoDeferredRenderUpdates_Concurrent</h6><p><code>RecreateRenderState_Concurrent</code>,<code>SendRenderTransform_Concurrent</code>,<code>SendRenderDynamicData_Concurrent</code>告诉引擎需要处理相应的渲染任务</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UActorComponent::DoDeferredRenderUpdates_Concurrent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">checkf</span>(!<span class="built_in">IsUnreachable</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	<span class="built_in">checkf</span>(!<span class="built_in">IsTemplate</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	<span class="built_in">checkf</span>(!<span class="built_in">IsPendingKill</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;%s&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line"></span><br><span class="line">	<span class="function">FScopeCycleCounterUObject <span class="title">ContextScope</span><span class="params">(<span class="keyword">this</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(!<span class="built_in">IsRegistered</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UE_LOG</span>(LogActorComponent, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;UpdateComponent: (%s) Not registered, Aborting.&quot;</span>), *<span class="built_in">GetPathName</span>());</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(bRenderStateDirty)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_PostTickComponentRecreate);</span><br><span class="line">		<span class="built_in">RecreateRenderState_Concurrent</span>();</span><br><span class="line">		<span class="built_in">checkf</span>(!bRenderStateDirty, <span class="built_in">TEXT</span>(<span class="string">&quot;Failed to route CreateRenderState_Concurrent (%s)&quot;</span>), *<span class="built_in">GetFullName</span>());</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">SCOPE_CYCLE_COUNTER</span>(STAT_PostTickComponentLW);</span><br><span class="line">		<span class="keyword">if</span>(bRenderTransformDirty)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Update the component&#x27;s transform if the actor has been moved since it was last updated.</span></span><br><span class="line">			<span class="built_in">SendRenderTransform_Concurrent</span>();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(bRenderDynamicDataDirty)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">SendRenderDynamicData_Concurrent</span>();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="SendRenderTransform-Concurrent"><a href="#SendRenderTransform-Concurrent" class="headerlink" title="SendRenderTransform_Concurrent"></a>SendRenderTransform_Concurrent</h6><p>这个函数在基类只做了基础实现，主要是派生类重写实现主要逻辑，类似的也包括<code>SendRenderDynamicData_Concurrent</code>,<code>CreateRenderState_Concurrent</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	<span class="built_in">check</span>(bRenderStateCreated);</span><br><span class="line">	bRenderTransformDirty = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LOG_RENDER_STATE</span></span><br><span class="line">	<span class="built_in">UE_LOG</span>(LogActorComponent, Log, <span class="built_in">TEXT</span>(<span class="string">&quot;SendRenderTransform_Concurrent: %s&quot;</span>), *<span class="built_in">GetPathName</span>());</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UPrimitiveComponent"><a href="#UPrimitiveComponent" class="headerlink" title="UPrimitiveComponent"></a>UPrimitiveComponent</h5><p>紧接上面，我们看看有形状体积等信息的<code>UPrimitiveComponent</code></p>
<h6 id="SendRenderTransform-Concurrent-1"><a href="#SendRenderTransform-Concurrent-1" class="headerlink" title="SendRenderTransform_Concurrent"></a>SendRenderTransform_Concurrent</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">UPrimitiveComponent::SendRenderTransform_Concurrent</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">UpdateBounds</span>();</span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">bool</span> bDetailModeAllowsRendering	= DetailMode &lt;= <span class="built_in">GetCachedScalabilityCVars</span>().DetailMode;</span><br><span class="line">	<span class="keyword">if</span>( bDetailModeAllowsRendering &amp;&amp; (<span class="built_in">ShouldRender</span>() || bCastHiddenShadow))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">GetWorld</span>()-&gt;Scene-&gt;<span class="built_in">UpdatePrimitiveTransform</span>(<span class="keyword">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	Super::<span class="built_in">SendRenderTransform_Concurrent</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到在实现基类逻辑之前执行了<code>FScene</code>内的函数<code>UpdatePrimitiveTransform</code></p>
<h5 id="FScene"><a href="#FScene" class="headerlink" title="FScene"></a>FScene</h5><blockquote>
<p>代码在 RendererScene.cpp中</p>
</blockquote>
<h6 id="UpdatePrimitiveTransform"><a href="#UpdatePrimitiveTransform" class="headerlink" title="UpdatePrimitiveTransform"></a>UpdatePrimitiveTransform</h6><p>在<code>UpdatePrimitiveTransform</code>函数中会判断该<code>Primitive</code>有没有<code>SceneProxy</code>，如果有<code>SceneProxy</code>则判断该<code>Primitive</code>是否需要重新创建，如果需要重新创建则需要先删除，然后再添加该<code>Primitive</code>；如果没有<code>SceneProxy</code>则直接加入到场景中。接着我们具体看一下<code>AddPrimitive</code>函数的具体实现：</p>
<h6 id="AddPrimitive"><a href="#AddPrimitive" class="headerlink" title="AddPrimitive"></a>AddPrimitive</h6><p> 此函数主要做了如下几件事情</p>
<ul>
<li>创建<code>SceneProxy</code>和<code>PrimitiveSceneInfo</code></li>
<li>利用<code>FPrimitiveSceneInfo</code>封装<code>UPrimitiveComponent</code>的信息，继续在<code>render</code>线程中进行操作</li>
<li>给渲染线程发送2个命令，分别是设置<code>Primitive</code>的<code>Transform</code>信息和将<code>PrimitiveSceneInfo</code>加入到渲染线程的数据集合中</li>
</ul>
<p>代码如下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FPrimitiveSceneProxy* PrimitiveSceneProxy = Primitive-&gt;<span class="built_in">CreateSceneProxy</span>();</span><br><span class="line">	Primitive-&gt;SceneProxy = PrimitiveSceneProxy;</span><br><span class="line"><span class="comment">// Create the primitive scene info.</span></span><br><span class="line">	FPrimitiveSceneInfo* PrimitiveSceneInfo = <span class="keyword">new</span> <span class="built_in">FPrimitiveSceneInfo</span>(Primitive, <span class="keyword">this</span>);</span><br><span class="line">	PrimitiveSceneProxy-&gt;PrimitiveSceneInfo = PrimitiveSceneInfo;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create any RenderThreadResources required.</span></span><br><span class="line">	<span class="built_in">ENQUEUE_RENDER_COMMAND</span>(CreateRenderThreadResourcesCommand)(</span><br><span class="line">		[Params](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">	&#123;</span><br><span class="line">		FPrimitiveSceneProxy* SceneProxy = Params.PrimitiveSceneProxy;</span><br><span class="line">		FScopeCycleCounter <span class="built_in">Context</span>(SceneProxy-&gt;<span class="built_in">GetStatId</span>());</span><br><span class="line">		SceneProxy-&gt;<span class="built_in">SetTransform</span>(Params.RenderMatrix, Params.WorldBounds, Params.LocalBounds, Params.AttachmentRootPosition);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Create any RenderThreadResources required.</span></span><br><span class="line">		SceneProxy-&gt;<span class="built_in">CreateRenderThreadResources</span>();</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>



<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ENQUEUE_RENDER_COMMAND</span>(AddPrimitiveCommand)(</span><br><span class="line">	[Scene, PrimitiveSceneInfo](FRHICommandListImmediate&amp; RHICmdList)</span><br><span class="line">	&#123;</span><br><span class="line">		FScopeCycleCounter <span class="built_in">Context</span>(PrimitiveSceneInfo-&gt;Proxy-&gt;<span class="built_in">GetStatId</span>());</span><br><span class="line">		Scene-&gt;<span class="built_in">AddPrimitiveSceneInfo_RenderThread</span>(RHICmdList, PrimitiveSceneInfo);</span><br><span class="line">	&#125;);</span><br></pre></td></tr></table></figure>

<h6 id="AddPrimitiveSceneInfo-RenderThread"><a href="#AddPrimitiveSceneInfo-RenderThread" class="headerlink" title="AddPrimitiveSceneInfo_RenderThread"></a>AddPrimitiveSceneInfo_RenderThread</h6><p><code>AddPrimitiveSceneInfo_RenderThread</code>函数是在渲染线程执行的，完成<code>PrimitiveBounds</code>、<code>PrimitiveFlagsCompact</code>等数据的初始化后，并调用<code>LinkAttachmentGroup</code>处理<code>primitive</code>的父子关系，调用<code>LinkLODParentComponent</code>处理LOD父子关系，然后调用<code>FPrimitiveSceneInfo::AddToScene</code></p>
<p><code>AddToScene</code>最终会把物体添加到列表<code>DrawList</code> 中去完成绘制，这里不继续深挖了,埋个扣子，以后来解开</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add the primitive to its shadow parent&#x27;s linked list of children.</span></span><br><span class="line">	<span class="comment">// Note: must happen before AddToScene because AddToScene depends on LightingAttachmentRoot</span></span><br><span class="line">PrimitiveSceneInfo-&gt;<span class="built_in">LinkAttachmentGroup</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set lod Parent information if valid</span></span><br><span class="line">PrimitiveSceneInfo-&gt;<span class="built_in">LinkLODParentComponent</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add the primitive to the scene.</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">bool</span> bAddToDrawLists = !(CVarDoLazyStaticMeshUpdate.<span class="built_in">GetValueOnRenderThread</span>() &amp;&amp; !WITH_EDITOR);</span><br><span class="line"><span class="keyword">if</span> (bAddToDrawLists)</span><br><span class="line">&#123;</span><br><span class="line">	PrimitiveSceneInfo-&gt;<span class="built_in">AddToScene</span>(RHICmdList, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">	PrimitiveSceneInfo-&gt;<span class="built_in">AddToScene</span>(RHICmdList, <span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">	PrimitiveSceneInfo-&gt;<span class="built_in">BeginDeferredUpdateStaticMeshes</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h5><blockquote>
<p>由此我们就大致整理一下思路</p>
</blockquote>
<p>设置Actor的位置，其实就是把新旧位置做一个插值，把这个插值传递给继承自<code>USceneComponent</code>的<code>MoveComponent</code>方法，然后在下一帧渲染出新的位置</p>
<p>这里也接上了并解释了之前<a href="%5Bhttps://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/%5D(https://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/)">AI_MoveTo</a>的内容了</p>
<p>上一张流程简图</p>
<p><img src="https://img.supervj.top/img/%E6%B8%B2%E6%9F%93.jpg"></p>
<h5 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h5><h6 id="场景中静态物体的渲染顺序堆栈表参考"><a href="#场景中静态物体的渲染顺序堆栈表参考" class="headerlink" title="场景中静态物体的渲染顺序堆栈表参考"></a>场景中静态物体的渲染顺序堆栈表参考</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ActorComponet::ExecuteRegisterEvents</span><br><span class="line">UPrimitiveComponent::CreateRenderState_Concurrent</span><br><span class="line">FScene:: AddPrimitive</span><br><span class="line">FScene:: AddPrimitiveSceneInfo_RenderThread</span><br><span class="line">FScene:: AddStaticMeshes</span><br><span class="line">FStaticMesh::AddToDrawLists</span><br><span class="line">FMobileBasePassOpaqueDrawingPolicyFactory::AddStaticMesh</span><br><span class="line">ProcessMobileBasePassMesh</span><br><span class="line">FDrawMobileBasePassStaticMeshAction:: Process</span><br><span class="line">AddMeshToStaticDrawList</span><br><span class="line"><span class="comment">//加入到scene GetMobileBasePassDrawList中</span></span><br></pre></td></tr></table></figure>

<p>最终加入队列 以<code>DrawingPolicy</code> 为<code>key </code>的<code>map</code>队列</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TStaticMeshDrawList&lt;TMobileBasePassDrawingPolicy&lt;FUniformLightMapPolicy, <span class="number">0</span>&gt; &gt; MobileBasePassUniformLightMapPolicyDrawList[EBasePass_MAX];</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/" class="post-title-link" itemprop="url">创建异步节点</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-01 00:00:00" itemprop="dateCreated datePublished" datetime="2020-06-01T00:00:00+08:00">2020-06-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:29:59" itemprop="dateModified" datetime="2021-08-02T16:29:59+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/editor/" itemprop="url" rel="index"><span itemprop="name">editor</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/" class="cy_cmt_count" data-xid="2020/06/01/UE4创建异步节点/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>7.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><img src="https://img.supervj.top/img/AIMoveTo/move_4.jpg"></p>
<blockquote>
<p>如图所示，我们经常在UE4内看到如此的异步节点，简单说此类节点的输出并非像函数一样瞬间完成，而是拥有自己的生命周期，此类节点一般在右上角有一个<strong>时钟标志</strong></p>
<p>本文讲解如何制作类似<code>AI_MoveTo</code>的异步节点</p>
<p>另一篇<a href="%5Bhttps://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/%5D(https://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/)">AI_MoveTo简单分析和扩展</a>介绍<code>AI_MoveTo</code>的简单运行机制和其他扩展方式</p>
</blockquote>
<hr>
<blockquote>
<ul>
<li>2020.11.24更新:</li>
</ul>
<p>更新各类移动扩展函数库以及K2Node</p>
<p><a href="git@github.com:VJien/MovementEx.git">github</a></p>
<p><img src="https://img.supervj.top//img/image-20201124134801666.png" alt="image-20201124134801666"></p>
<ul>
<li>2021.2.25更新:</li>
</ul>
<p>基于<code>UBlueprintAsyncActionBase</code>的异步节点 <a href="#Asyc">跳转</a></p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/06/01/UE4%E5%88%9B%E5%BB%BA%E5%BC%82%E6%AD%A5%E8%8A%82%E7%82%B9/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/" class="post-title-link" itemprop="url">AI_MoveTo分析和扩展</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-27 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-27T00:00:00+08:00">2020-05-27</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:35:31" itemprop="dateModified" datetime="2021-08-02T16:35:31+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/editor/" itemprop="url" rel="index"><span itemprop="name">editor</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/" class="cy_cmt_count" data-xid="2020/05/27/AI_MoveTo研究/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>20k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>18 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="UK2Node-AIMoveTo"><a href="#UK2Node-AIMoveTo" class="headerlink" title="UK2Node_AIMoveTo"></a>UK2Node_AIMoveTo</h2><p><img src="https://img.supervj.top/img/AIMoveTo/move_4.jpg"></p>
<blockquote>
<p>这是我们最熟悉的编辑器模式下的AI_MoveTo节点，也就是那个自带OnSuccess和OnFailed的异步节点，在蓝图中大多数时候使用起来都得心应手非常方便，但是它有个最大的缺点，异步节点意味着他有自己的生命周期，不能放到函数中使用，同样的，在代码中也没有此类节点，那么接下来我们尝试解决这一问题</p>
</blockquote>
<p>翻看此节点的代码，没几行代码,主要看如下</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/05/27/AI_MoveTo%E7%A0%94%E7%A9%B6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/05/21/%E4%BD%BF%E7%94%A8ApexPhysXLab%E5%88%B6%E4%BD%9CUE4%E7%9A%84%E7%A0%B4%E6%8D%9F%E7%89%A9%E4%BD%93%EF%BC%88%20DestructibleMesh%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/21/%E4%BD%BF%E7%94%A8ApexPhysXLab%E5%88%B6%E4%BD%9CUE4%E7%9A%84%E7%A0%B4%E6%8D%9F%E7%89%A9%E4%BD%93%EF%BC%88%20DestructibleMesh%EF%BC%89/" class="post-title-link" itemprop="url">使用ApexPhysXLab制作UE4的破损物体(DestructibleMesh)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-21 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-21T00:00:00+08:00">2020-05-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:22:13" itemprop="dateModified" datetime="2021-08-02T16:22:13+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/physics/" itemprop="url" rel="index"><span itemprop="name">physics</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/05/21/%E4%BD%BF%E7%94%A8ApexPhysXLab%E5%88%B6%E4%BD%9CUE4%E7%9A%84%E7%A0%B4%E6%8D%9F%E7%89%A9%E4%BD%93%EF%BC%88%20DestructibleMesh%EF%BC%89/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/05/21/%E4%BD%BF%E7%94%A8ApexPhysXLab%E5%88%B6%E4%BD%9CUE4%E7%9A%84%E7%A0%B4%E6%8D%9F%E7%89%A9%E4%BD%93%EF%BC%88%20DestructibleMesh%EF%BC%89/" class="cy_cmt_count" data-xid="2020/05/21/使用ApexPhysXLab制作UE4的破损物体（ DestructibleMesh）/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>276</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>UE4自带的DestructibleMesh系统的破碎方式比较单一，可以用英伟达的ApexPhysXLab工具制作自定义破碎文件，然后导入UE4</p>
<p>本文介绍通过使用这一工具制作UE4破碎物体的流程</p>
<p>工具下载地址<a href="**https://developer.nvidia.com/gameworksdownload#?dn=physx-lab-1-3-0**">点击下载</a></p>
</blockquote>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_1.png"></p>
<h3 id="PhysXLab流程"><a href="#PhysXLab流程" class="headerlink" title="PhysXLab流程"></a>PhysXLab流程</h3><p>如下图所示，导入3D模型</p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_2.png"></p>
<h5 id="三种破碎方式"><a href="#三种破碎方式" class="headerlink" title="三种破碎方式"></a>三种破碎方式</h5><p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_3.png"></p>
<h6 id="Slice模式"><a href="#Slice模式" class="headerlink" title="Slice模式"></a>Slice模式</h6><p>如下图所示，红色框内为主要设置的参数</p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_4.png"></p>
<p>效果如下</p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_5.png"></p>
<h6 id="Cutout模式"><a href="#Cutout模式" class="headerlink" title="Cutout模式"></a>Cutout模式</h6><p>主要用黑白通道图来切割，<strong>注意黑白通道只是平面投射，跟UV无关，所以纹理如果要配合切割需要单独制作配合好的纹理及黑白图</strong></p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_6.png"></p>
<p>效果如下</p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_7.png"></p>
<h6 id="Voronoi模式"><a href="#Voronoi模式" class="headerlink" title="Voronoi模式"></a>Voronoi模式</h6><p>类似UE4内的破碎</p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_8.png"></p>
<p> 效果如下</p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_9.png"></p>
<h5 id="导出"><a href="#导出" class="headerlink" title="导出"></a>导出</h5><p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_10.png"></p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_11.png"></p>
<h3 id="UE4流程"><a href="#UE4流程" class="headerlink" title="UE4流程"></a>UE4流程</h3><p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_12.png"></p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_13.png"></p>
<p>用一个模拟子弹来制造破碎效果</p>
<p><img src="https://img.supervj.top/img/PhyXLab/PhyXLab_14.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/05/21/%E7%94%A8Niagara%E7%BB%98%E5%88%B6%E6%A0%B7%E6%9D%A1%E7%BA%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/21/%E7%94%A8Niagara%E7%BB%98%E5%88%B6%E6%A0%B7%E6%9D%A1%E7%BA%BF/" class="post-title-link" itemprop="url">用Niagara的Ribbon绘制样条线</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-21 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-21T00:00:00+08:00">2020-05-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:39:19" itemprop="dateModified" datetime="2021-08-02T16:39:19+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/05/21/%E7%94%A8Niagara%E7%BB%98%E5%88%B6%E6%A0%B7%E6%9D%A1%E7%BA%BF/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/05/21/%E7%94%A8Niagara%E7%BB%98%E5%88%B6%E6%A0%B7%E6%9D%A1%E7%BA%BF/" class="cy_cmt_count" data-xid="2020/05/21/用Niagara绘制样条线/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>最近由于项目需要用到鼠标在场景利绘制曲线，方案有很多，比如SplineMesh，ProceduralMesh 等等，回头一想用特效也可以试试</p>
<p>本案例使用虚幻4.22版本演示</p>
<p>用Niagara的Ribbon绘制样条线的功能</p>
</blockquote>
<p><img src="https://img.supervj.top/img/niagara/niagara_0.gif"></p>
<h5 id="模块函数-NiagaraModuleScript"><a href="#模块函数-NiagaraModuleScript" class="headerlink" title="模块函数 NiagaraModuleScript"></a>模块函数 NiagaraModuleScript</h5><ul>
<li>模块函数是Niagara系统的函数库，是niagara系统最主要区别于老例子系统的其中一点</li>
</ul>
<p>创建函数库 <code>NM_Test1</code></p>
<p><img src="https://img.supervj.top/img/niagara/niagara_1.jpg"></p>
<p>完成如上节点连接</p>
<p>注意：变量的前缀是对应模块，这个不能随意更改，创建的时候就选好模块会自动添加前缀；如果是系统已有变量，就不需要自己更改名称，如<code>Emitter.age</code>，表示发射器的生命周期</p>
<ul>
<li>User.SP：User分类下的Spline变量，本案例用下面参数代替</li>
<li>Module.Count：函数输入参数，本函数中用于控制发射数量</li>
<li>SampleSplinePositionByUnitDistanceWS:输入0-1输出曲线从开始到结束的世界空间位置</li>
<li>ExecutionIndex:当前粒子的序号</li>
</ul>
<p>简单描述这个函数的功能就是根据发射粒子在所有发射粒子中的百分比对应到曲线spline的长度百分比</p>
<h5 id="粒子发射器-Emitter"><a href="#粒子发射器-Emitter" class="headerlink" title="粒子发射器 Emitter"></a>粒子发射器 Emitter</h5><p><img src="https://img.supervj.top/img/niagara/niagara_2.jpg"></p>
<p>随意创建一个发射器，删除多余节点，配置图所示</p>
<p>刚开始比较容易混淆的概念是 Emitter的spawn，update与Particle的Spawn，Update的概念</p>
<ul>
<li>Emitter针对的就是整个发射器的操作，约等于老系统的Required和部分Spawn的内容，如整个发射器的生命周期，是否循环</li>
<li>Particle控制每个粒子的属性和功能，如每个粒子的大小颜色等</li>
<li>不恰当的比喻就是Emitter就是Actor，Particle就是Component</li>
</ul>
<p>图中关键节点解释</p>
<ul>
<li>创建3个User变量，User变量可以到外部设置</li>
<li>创建Emitter模块的<code>Emitter.SpawnCount</code>变量，暴力一点可以直接跳过直接用User的</li>
<li>发射器创建的时候用<code>User.SpawnCount</code>设置<code>Emitter.SpawnCount</code></li>
<li><code>Emitter.SpawnCount</code>去设置<code>SpawnBurstInstaneous</code>的发射数量</li>
<li>修改<code>Render</code>模块中的粒子类型为<code>Ribbon</code></li>
<li>设置Ribbon的宽度</li>
<li>在Spawn（在Update也可以） 中加上自定义的函数<code>NM_Test1</code>，并把<code>EmitterSpawnCount</code>设置为输入参数</li>
</ul>
<h5 id="粒子系统-NiagaraSystem"><a href="#粒子系统-NiagaraSystem" class="headerlink" title="粒子系统 NiagaraSystem"></a>粒子系统 NiagaraSystem</h5><blockquote>
<p> 汇总所有Emitter的集合，同时可以实例化到场景或者类里的类;同时也可以再次修改Emitter中所有参数</p>
</blockquote>
<p><img src="https://img.supervj.top/img/niagara/niagara_3.jpg"></p>
<p>如图所示，可以使用多个发射器，可以设置User模块的参数，可以拖拽不同发射器的作用时间（类似动画）</p>
<p>本案例中只需要添加一个发射器</p>
<h5 id="画线类-DrawItem"><a href="#画线类-DrawItem" class="headerlink" title="画线类 DrawItem"></a>画线类 DrawItem</h5><p><img src="https://img.supervj.top/img/niagara/niagara_4.jpg"></p>
<ul>
<li><p>目前版本貌似没有更直观的方法设置Spline变量，强行用设置Actor变量尽然是可以的(lll￢ω￢)</p>
</li>
<li><p>提供对外函数<code>AddPoint(FVector)</code>用于添加曲线点</p>
</li>
</ul>
<h5 id="PlayerController"><a href="#PlayerController" class="headerlink" title="PlayerController"></a>PlayerController</h5><blockquote>
<p>不要忘记开启项目设置里Input模块下的UseMouseForTouch</p>
</blockquote>
<p><img src="https://img.supervj.top/img/niagara/niagara_5.jpg"></p>
<p>蓝图比较简单，简单描述就是在鼠标按下移动后用射线点通过DrawItem添加曲线点</p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><ol>
<li>用Niagara类绘制曲线模型算是比较简单方便的，Niagara在性能优化上也不错</li>
<li>曲线在长度到一定程度后会有明显分段情况出现，不够圆滑，目前版本没有公开Ribbon的设置段数的变量</li>
<li>据说Niagara在4.25才是正式版，目前无法保证bug问题</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3CH/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3CH/" class="post-title-link" itemprop="url">《Multiplayer RPG Template》说明文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-19 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-19T00:00:00+08:00">2020-05-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:13:42" itemprop="dateModified" datetime="2021-08-02T16:13:42+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3CH/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3CH/" class="cy_cmt_count" data-xid="2020/05/19/超4说明文档CH/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p> 这是一份<a target="_blank" rel="noopener" href="https://www.unrealengine.com/marketplace/zh-CN/product/multiplayer-rpg-template">Multiplayer RPG Template</a>的说明文档,内容包含其中主要系统的配置和制作方法</p>
<p>此案例是基于UE4的<strong>ListerServer</strong>建立的局域网联机游戏demo，参考作品WOW</p>
<p>基于UE4版本4.25</p>
<p>demo尚且有未完善的地方，后续会跟进优化和修复</p>
</blockquote>
<h3 id="技能系统"><a href="#技能系统" class="headerlink" title="技能系统"></a>技能系统</h3><p><img src="https://img.supervj.top/imgchao4_skill1.jpg"></p>
<p>如上图所示，此图为技能表的配置信息，下面简述其中重要的参数</p>
<ul>
<li>Action: 这个变量代表这个行为的唯一ID，原则上跟表格的RowName相同，很多逻辑中需要通过这个ID查找关于这个技能的所有信息，或者通过这个ID执行这个技能等</li>
<li>Display(struct)：3个参数用来显示这个技能一般信息，比如名字或者说明还有图标的显示，在UMG上有相关的体现，当然你也可以用来自定义<ul>
<li><img src="https://img.supervj.top/imgchao4_skill4.jpg"></li>
<li><img src="https://img.supervj.top/imgchao4_skill5.jpg"></li>
</ul>
</li>
<li>CastData(struct)：这个是一个施法的结构体，主要设置的是施法的方式和条件<ul>
<li>Type:比如默认的读条施法，持续施法，攻击叠加类的施法等方式</li>
<li>Time:施法所需要的时长，0意味着瞬发</li>
<li>Duration:如果是持续施法，那么这个参数意味着引导时间</li>
<li>KeepAttackStat:施法完以后会继续进行普通攻击</li>
<li>MotionCast:移动施法，设置为否的话必须站立施法，一旦移动就打断施法</li>
<li>NotTargetCast:不需要目标的施法，一般用于范围技能比如火雨之类</li>
</ul>
</li>
<li>Mp:消耗魔法值，战士为怒气值</li>
<li>CD:冷却时间</li>
<li>MaxRange：最大释放范围，按照虚幻单位计算，0意味着无限制</li>
<li>LearnGold/Level:学习该技能的前置条件，0意味着无要求</li>
<li>RangeSelectRange:如果是范围选择的技能，此参数表示作用的半径</li>
<li>TargetType:目标类型，作用地方还是友方等</li>
<li>SkillClass:技能实例的类，无需手动创建</li>
</ul>
<h5 id="SkillRef"><a href="#SkillRef" class="headerlink" title="SkillRef"></a>SkillRef</h5><blockquote>
<p>这个是通过表格配置的SkillClass创建的，无需手动创建，你只需要制作这个类的逻辑和效果</p>
<p>这个类是继承自<code>BP_BaseSkill</code>,里面有一些乱七八糟的蓝图逻辑，不过并不是全部都是必须使用的，这个类很多情况下你可以自由发挥，反正技能释放了以后就通过这个类来控制这个技能实例的运行</p>
<p>下面就通过<code>IceBullet</code>这个技能类来说明一下</p>
</blockquote>
<p><img src="https://img.supervj.top/imgchao4_skill2.jpg"></p>
<p><code>IceBullet</code>继承于<code>ProjectileBase</code>，如上图所示，这是这个类的基本参数类型</p>
<ul>
<li>speed:飞行速度，依赖<code>ProjectileComponent</code></li>
<li>StopDistance:停止的距离，因为这个类是追踪目标飞行的，所以会总有接近并且到达目标的时候，到达目标并停止以后会产生一段逻辑</li>
<li>Duration:持续时间，如果没有命中到达时间以后也会摧毁自己</li>
<li>Sound/FX:相关的特效配置，Start可以用于产生的时候播放，Hit可以用于打中目标以后播放，但都需要手动释放，<ul>
<li>在<code>ProjectileBase</code>已经实现了<code>BeginPlay</code>以后调用Start的效果</li>
<li>在打中目标后已经实现播放Hit的效果</li>
</ul>
</li>
<li>BuffData：如果这个技能有buff/debuff可以设置这个类，需要手动调用方法来创建并运行buff类,如下图</li>
</ul>
<p><img src="https://img.supervj.top/imgchao4_skill3.jpg"></p>
<h5 id="BuffRef"><a href="#BuffRef" class="headerlink" title="BuffRef"></a>BuffRef</h5><blockquote>
<p>这是Buff的实例类，通过SkillRef内部调用<code>CreateBuff</code>方法创建</p>
<p>通过重写<code>BuffInit</code>和<code>BuffEnd</code>方法来实现自定义的逻辑，如果是拥有持续效果，那么你可以重写<code>BuffDelta</code> 方法来制作持续调用的逻辑</p>
</blockquote>
<h3 id="装备系统"><a href="#装备系统" class="headerlink" title="装备系统"></a>装备系统</h3><p><img src="https://img.supervj.top/imgchao4_equp1.jpg"></p>
<blockquote>
<p>如上图所示，这个是装备信息的配置表，下面简单介绍其中主要参数的作用</p>
</blockquote>
<ul>
<li>BodyPart：装备对应的位置</li>
<li>Mesh/Mat:用于显示这个装备实体的模型，装备在人物上或者丢弃到世界中的显示</li>
<li>Property:如字面意思就是2种属性，其中Adv属性会随着Base的更改而变化</li>
</ul>
<h3 id="道具系统"><a href="#道具系统" class="headerlink" title="道具系统"></a>道具系统</h3><p><img src="https://img.supervj.top/imgchao4_prop1.jpg"></p>
<blockquote>
<p>道具系统类似于装备系统</p>
</blockquote>
<ul>
<li>EffectType:作用类型，本案例只制作了治疗效果和增加魔法的效果</li>
<li>Value: 可以设置作用效果的范围值，当然这个不是必须的，具体是下面的道具类内部实现</li>
<li>CanBeStacked:如果是否那么一个道具占据背包栏的一格，否则么可以堆放到一起</li>
<li>ActionClass:道具类实现逻辑的类，参考Skill的实例实现，具体逻辑可以写到这个类里面</li>
</ul>
<h3 id="掉落系统"><a href="#掉落系统" class="headerlink" title="掉落系统"></a>掉落系统</h3><p><img src="https://img.supervj.top/imgchao4_drop1.jpg"></p>
<blockquote>
<p>如上图所示，掉落系统的配置放在<code>DataSystem</code> 这个类里面，为什么没有配置表格呢？O(∩_∩)O</p>
<p>当然也可以，你可以自己创建一个类似的表格然后替换其中的逻辑，这个很简单</p>
</blockquote>
<p>这个配置信息是一个Map键值对，键对应的是角色的类，值即是掉落信息数组</p>
<ul>
<li>Action:选择装备/道具等的Action名称</li>
<li>Type:选择是装备/道具，当然你要是想掉落技能的话理论上也可以，请自由发挥</li>
<li>Amount:掉落数量</li>
<li>Probability:概率，这个概率计算是在角色创建的时候就完成的，非击杀的时候</li>
</ul>
<h3 id="任务系统"><a href="#任务系统" class="headerlink" title="任务系统"></a>任务系统</h3><p><img src="https://img.supervj.top/imgchao4_task1.jpg"></p>
<blockquote>
<p> 如上图所示，这是任务表格的配置信息</p>
</blockquote>
<ul>
<li>Titile：任务的标题，会显示在任务栏内的抬头标题部分</li>
<li>Target：任务的目标</li>
<li>DynamicTargetStat:这个会动态的刷新，具体实现的逻辑在下面的TaskClass内</li>
<li>Descripion:任务描述</li>
<li>Reward：奖励</li>
</ul>
<h5 id="TaskRef"><a href="#TaskRef" class="headerlink" title="TaskRef"></a>TaskRef</h5><p><img src="https://img.supervj.top/imgchao4_task2.jpg"></p>
<p><img src="https://img.supervj.top/imgchao4_task3.jpg"></p>
<blockquote>
<p>如上图所示，每接受一个任务以后就会产生一个任务类来作为该任务的观察者(代理)</p>
<p>具体这个任务是干什么的你可以通过实现这个类内的逻辑来管理，同时设置任务目标里的动态信息</p>
</blockquote>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h5 id="怪物刷新"><a href="#怪物刷新" class="headerlink" title="怪物刷新"></a>怪物刷新</h5><p><img src="https://img.supervj.top/imgchao4_aigenerat1.jpg"></p>
<blockquote>
<p>怪物刷新是在场景里放置一个<code>BP_AIGenerator</code>管理类来完成的</p>
</blockquote>
<ul>
<li>MaxNum:刷新的最大数量</li>
<li>AIClass:设置刷新角色的类，超过1个的时候就随机从中刷新</li>
<li>Range:以该管理类的位置为中心的半径内刷新怪物</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://supervj.top/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.supervj.top/imgHEAD_Icon.png">
      <meta itemprop="name" content="VJ东">
      <meta itemprop="description" content=" 如果我们不曾相遇 ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="月光林地">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/" class="post-title-link" itemprop="url">《Multiplayer RPG Template》Documentation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-19 00:00:00" itemprop="dateCreated datePublished" datetime="2020-05-19T00:00:00+08:00">2020-05-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-08-02 16:13:27" itemprop="dateModified" datetime="2021-08-02T16:13:27+08:00">2021-08-02</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/other/" itemprop="url" rel="index"><span itemprop="name">other</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Changyan：</span>
    
    
      <a title="changyan" href="/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/#SOHUCS" itemprop="discussionUrl">
        <span id="url::http://supervj.top/2020/05/19/%E8%B6%854%E8%AF%B4%E6%98%8E%E6%96%87%E6%A1%A3EN/" class="cy_cmt_count" data-xid="2020/05/19/超4说明文档EN/" itemprop="commentCount"></span>
      </a>
    
  </span>
  
  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>This is <a target="_blank" rel="noopener" href="https://www.unrealengine.com/marketplace/zh-CN/product/multiplayer-rpg-template">Multiplayer RPG Template</a> Documentation,its about configuration and production method of the main system</p>
<p>This case is based on UE4’s  ListerServer  built-in LAN online game demo, refer to the work WOW</p>
<p>Based on UE4 version 4.25</p>
<p>There are still some imperfections in the demo, which will be followed up for optimization and repair</p>
</blockquote>
<h3 id="Skill-system"><a href="#Skill-system" class="headerlink" title="Skill system"></a>Skill system</h3><p><img src="https://img.supervj.top/imgchao4_skill1.jpg"></p>
<p>As shown in the above figure, this figure is the configuration information of the skill table. The important parameters are briefly described below</p>
<ul>
<li>Action: This variable represents the unique ID of this behavior. In principle, it is the same as the RowName of the table. In many logics, you need to use the ID to find all information about the skill, or use the ID to execute the skill</li>
<li>Display(struct)：3 parameters are used to display the general information of this skill, such as the display of the name or description and icons, which are related to the UMG, of course, you can also customize<ul>
<li><img src="https://img.supervj.top/imgchao4_skill4.jpg"></li>
<li><img src="https://img.supervj.top/imgchao4_skill5.jpg"></li>
</ul>
</li>
<li>CastData(struct)：This is a spell-casting structure, which mainly sets the method and conditions of the spell-casting<ul>
<li>Type:For example, the default reading spell casting, continuous casting, attack superimposing casting and other methods</li>
<li>Time:The time it takes to cast, 0 means instant</li>
<li>Duration:If it is a continuous cast, then this parameter means the lead time</li>
<li>KeepAttackStat:After the cast is finished, the normal attack will continue</li>
<li>MotionCast:Move cast, if set to No, you must stand cast, once you move, interrupt cast</li>
<li>NotTargetCast:Does not require target casting, and is generally used for range skills such as Fire and Rain</li>
</ul>
</li>
<li>Mp:Mana cost, Warrior Rage</li>
<li>CD:Cooling time</li>
<li>MaxRange：Maximum release range, calculated in Unreal Units, 0 means unlimited</li>
<li>LearnGold/Level:Prerequisites for learning this skill, 0 means no requirement</li>
<li>RangeSelectRange:If it is a skill selected by range, this parameter indicates the radius of the effect</li>
<li>TargetType:Target type, place of action or friend</li>
<li>SkillClass:Skill class, no need to create manually</li>
</ul>
<h5 id="SkillRef"><a href="#SkillRef" class="headerlink" title="SkillRef"></a>SkillRef</h5><blockquote>
<p>This is created by the SkillClass configured in the table, there is no need to manually create it, you only need to make the logic and effects of this class</p>
<p>This class is inherited from <code>BP_BaseSkill</code>, which has some messy blueprint logic, but not all are necessary to use. In this case, you can freely play in many cases. Anyway, after the skill is released, you can control this skill through this class Running the instance</p>
<p>Let’s explain it through the skill class of <code>IceBullet</code></p>
</blockquote>
<p><img src="https://img.supervj.top/imgchao4_skill2.jpg"></p>
<p><code>IceBullet</code>Inherit from<code>ProjectileBase</code>，As shown in the figure above, this is the basic parameter type of this class</p>
<ul>
<li>speed: flight speed, depends on <code>ProjectileComponent</code></li>
<li>StopDistance: the distance to stop, because this class is to track the target flight, so there will always be when approaching and reaching the target, a logic will be generated after reaching the target and stopping</li>
<li>Duration: Duration, if there is no hit, the time will destroy yourself</li>
<li>Sound / FX: related special effects configuration, Start can be used to play when it is generated, Hit can be used to play after hitting the target, but all need to be manually released<br>   - The effect of calling Start after <code>ProjectileBase</code> has realized<code> BeginPlay</code><br>   - The Hit effect has been achieved after hitting the target</li>
<li>BuffData: If this skill has buff / debuff, you can set this class, you need to manually call the method to create and run the buff class, as shown below</li>
</ul>
<p><img src="https://img.supervj.top/imgchao4_skill3.jpg"></p>
<h5 id="BuffRef"><a href="#BuffRef" class="headerlink" title="BuffRef"></a>BuffRef</h5><blockquote>
<p>This is an instance class of Buff, created by internally calling <code>CreateBuff</code> method of SkillRef</p>
<p>By rewriting the <code>BuffInit</code> and<code> BuffEnd</code> methods to achieve custom logic, if it has a continuous effect, then you can rewrite the <code>BuffDelta</code> method to make the logic of continuous calls</p>
</blockquote>
<h3 id="EquipSystem"><a href="#EquipSystem" class="headerlink" title="EquipSystem"></a>EquipSystem</h3><p><img src="https://img.supervj.top/imgchao4_equp1.jpg"></p>
<blockquote>
<p>As shown in the figure above, this is the configuration table of the equipment information. The following briefly introduces the role of the main parameters</p>
</blockquote>
<ul>
<li>BodyPart： the corresponding position of the equipment</li>
<li>Mesh/Mat: Used to display the model of this equipment entity, equipped on the character or discarded into the world</li>
<li>Property: literally means 2 kinds of properties, of which Adv property will change with the change of Base</li>
</ul>
<h3 id="PropSystem"><a href="#PropSystem" class="headerlink" title="PropSystem"></a>PropSystem</h3><p><img src="https://img.supervj.top/imgchao4_prop1.jpg"></p>
<blockquote>
<p>The prop system is similar to the equipment system</p>
</blockquote>
<ul>
<li>EffectType:Effect type, this case only made the healing effect and the effect of increasing magic</li>
<li>Value: You can set the range value of the effect, of course, this is not necessary, specifically the internal implementation of the following prop class</li>
<li>CanBeStacked:If one item occupies one space in the backpack bar, otherwise it can be stacked together</li>
<li>ActionClass:Prop class implement logic class, refer to Skill instance implementation, specific logic can be written into this class</li>
</ul>
<h3 id="DropSystem"><a href="#DropSystem" class="headerlink" title="DropSystem"></a>DropSystem</h3><p><img src="https://img.supervj.top/imgchao4_drop1.jpg"></p>
<blockquote>
<p>As shown in the figure above, the configuration of the drop system is placed in the <code>DataSystem</code> class. Why is there no configuration table? O (∩_∩) O</p>
<p>Of course, you can create a similar table yourself and replace the logic in it. This is very simple.</p>
</blockquote>
<p>This configuration information is a Map key-value pair, the key corresponds to the role class, and the value is the drop information array</p>
<ul>
<li>Action:Select the action name of equipment / props, etc.</li>
<li>Type:Choose equipment / props. Of course, if you want to drop skills, you can theoretically do it. Please play freely.</li>
<li>Amount:number of drops</li>
<li>Probability:Probability, this probability calculation is done when the character is created, when not kill</li>
</ul>
<h3 id="TaskSystem"><a href="#TaskSystem" class="headerlink" title="TaskSystem"></a>TaskSystem</h3><p><img src="https://img.supervj.top/imgchao4_task1.jpg"></p>
<blockquote>
<p> As shown in the figure above, this is the configuration information of the task table</p>
</blockquote>
<ul>
<li>Titile：the title of the task, which will be displayed in the header section of the task bar</li>
<li>Target：the target of the task</li>
<li>DynamicTargetStat:This will be refreshed dynamically, the specific implementation logic is in the following TaskClass</li>
</ul>
<h5 id="TaskRef"><a href="#TaskRef" class="headerlink" title="TaskRef"></a>TaskRef</h5><p><img src="https://img.supervj.top/imgchao4_task2.jpg"></p>
<p><img src="https://img.supervj.top/imgchao4_task3.jpg"></p>
<blockquote>
<p>As shown in the figure above, each time a task is accepted, a task class will be generated as an observer (agent) of the task</p>
<p>Specifically what the task is for, you can manage it by implementing the logic in this class, while setting the dynamic information in the task goal</p>
</blockquote>
<h3 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h3><h5 id="Monster-refresh"><a href="#Monster-refresh" class="headerlink" title="Monster refresh"></a>Monster refresh</h5><p><img src="https://img.supervj.top/imgchao4_aigenerat1.jpg"></p>
<blockquote>
<p>Monster refresh is done by placing a <code>BP_AIGenerator</code> management class in the scene</p>
</blockquote>
<ul>
<li>MaxNum: the maximum number of refreshes</li>
<li>AIClass: Set the class for refreshing the character, if more than one, it will be randomly refreshed from it</li>
<li>Range: refresh monsters within a radius centered on the position of the management class</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>


<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2020 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">VJ东</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">783k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">11:52</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>

<script src="/js/local-search.js"></script>





  <script>
    NProgress.configure({
      showSpinner: true
    });
    NProgress.start();
    document.addEventListener('readystatechange', () => {
      if (document.readyState === 'interactive') {
        NProgress.inc(0.8);
      }
      if (document.readyState === 'complete') {
        NProgress.done();
      }
    });
    document.addEventListener('pjax:send', () => {
      NProgress.start();
    });
    document.addEventListener('pjax:success', () => {
      NProgress.done();
    });
  </script>

  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'none'
      },
      options: {
        renderActions: {
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              const target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    const script = document.createElement('script');
    script.src = '//cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js';
    script.defer = true;
    document.head.appendChild(script);
  } else {
    MathJax.startup.document.state(0);
    MathJax.typesetClear();
    MathJax.texReset();
    MathJax.typeset();
  }
</script>



  <script id="cy_cmt_num" src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cyvbKaUjB"></script>


</body>
</html>
